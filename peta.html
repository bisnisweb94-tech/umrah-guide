<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Peta Premium Masjidil Haram - AL HARAMAIN</title>

    <!-- Hide lock instantly if already unlocked (injected before paint) -->
    <script>
        (function () {
            var unlocked = false;
            try { unlocked = localStorage.getItem('site_unlocked') === 'true'; } catch (e) { }
            if (!unlocked) unlocked = location.search.indexOf('unlocked=1') !== -1;
            if (unlocked) {
                document.write('<style>#site-lock{display:none!important;transition:none!important}</style>');
                try { localStorage.setItem('site_unlocked', 'true'); } catch (e) { }
            }
        })();
    </script>

    <!-- PWA Standalone -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Al Haramain">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a3a2a">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

    <!-- Leaflet & GIS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- Fonts & Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Amiri:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            background: #f5f5f5;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        /* ========== LAYOUT & COMPONENTS (MOBILE-FIRST) ========== */
        .map-header {
            position: fixed;
            top: 12px;
            left: 12px;
            right: 12px;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .search-box {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 12px;
            background: white;
            border-radius: 8px;
            z-index: 1001;
            /* Higher than chips */
            position: relative;
        }

        .search-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: #f1f3f4;
            border-radius: 8px;
            padding: 10px 14px;
            gap: 10px;
        }

        .search-input-wrapper input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font-size: 16px;
            color: #202124;
            min-width: 0;
            /* Fix flex child overflow */
        }

        .search-input-wrapper i {
            color: #5f6368;
        }

        /* Directions Box - Hidden by default */
        .directions-box {
            display: none;
            padding: 0 16px 16px;
            background: white;
            border-radius: 0 0 8px 8px;
        }

        .directions-box.active {
            display: block;
        }

        .dir-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .dir-dots {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 12px;
            width: 20px;
        }

        .dot-start {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #5f6368;
        }

        .dot-line {
            width: 2px;
            height: 24px;
            background: #dadce0;
            margin: 4px 0;
            flex: 1;
        }

        .dot-end {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #ea4335;
            background: #ea4335;
        }

        .dir-inputs {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dir-input-wrapper {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dir-input-wrapper input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font-size: 14px;
            color: #202124;
        }

        .dir-input-wrapper .pick-btn {
            background: none;
            border: none;
            color: #5f6368;
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
        }

        .dir-input-wrapper .pick-btn:hover {
            color: #1a73e8;
        }

        .dir-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 8px;
            border-top: 1px solid #f1f3f4;
        }

        .nav-btn-start {
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 18px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .nav-btn-start:disabled {
            background: #dadce0;
            color: white;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* ========== OVERLAYS & MODALS ========== */
        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: #34a853;
            color: white;
            z-index: 1100;
            display: none;
            flex-direction: row;
            gap: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
            align-items: center;
        }

        .nav-overlay.active {
            display: flex;
        }

        .landmark-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
        }

        .landmark-modal.active {
            display: flex;
        }

        .chips-wrapper {
            position: fixed;
            top: 84px;
            /* Below search box on mobile */
            left: 0;
            right: 0;
            z-index: 999;
            height: 48px;
            /* Explicit height for layout stability */
            display: flex;
            align-items: center;
            pointer-events: none;
            /* Allow clicks to pass through wrapper */
        }

        .category-chips {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 0 12px;
            width: 100%;
            height: 100%;
            align-items: center;
            -ms-overflow-style: none;
            scrollbar-width: none;
            scroll-behavior: smooth;
            pointer-events: auto;
            /* Re-enable clicks on chips */
        }

        .category-chips::-webkit-scrollbar {
            display: none;
        }

        /* Gradient Fades for Google Maps Effect */
        .scroll-fade-left,
        .scroll-fade-right {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 40px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .scroll-fade-left {
            left: 0;
            background: linear-gradient(to right, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0) 100%);
        }

        .scroll-fade-right {
            right: 0;
            background: linear-gradient(to left, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0) 100%);
        }

        /* Classes to toggle fades */
        .chips-wrapper.can-scroll-left .scroll-fade-left {
            opacity: 1;
        }

        .chips-wrapper.can-scroll-right .scroll-fade-right {
            opacity: 1;
        }

        .category-chips::-webkit-scrollbar {
            display: none;
        }

        .chip {
            padding: 8px 14px;
            border-radius: 20px;
            background: white;
            border: 1px solid #dadce0;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .chip:hover,
        .chip.active {
            background: #e8f0fe;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        .chip i {
            margin-right: 6px;
        }

        .floating-btns {
            position: fixed;
            bottom: 24px;
            left: 12px;
            z-index: 1002;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .fab-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            color: #202124;
        }

        .fab-btn:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
            transform: scale(1.05);
        }

        .fab-btn.kaaba {
            color: #f57c00;
            /* Orange */
            font-size: 22px;
        }

        .fab-btn.hidden {
            display: none;
        }

        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 70vh;
            display: flex;
            flex-direction: column;
        }

        .bottom-sheet.expanded {
            transform: translateY(0);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            max-height: 320px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 0 0 12px 12px;
            z-index: 1002;
            /* Higher than bottom sheet */
            display: none;
        }

        /* Other base styles (markers, popups, etc.) */
        .pinhole-marker {
            background: none !important;
            border: none !important;
            cursor: pointer;
        }

        .pinhole-marker .marker-wrapper {
            position: relative;
            width: 0;
            height: 0;
        }

        .pinhole-marker .marker-default {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 4px;
            left: 0;
            top: 0;
            transform: translate(-16px, -16px);
        }

        .marker-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #1a73e8;
            border: 2.5px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .marker-circle i {
            color: white;
            font-size: 13px;
        }

        .marker-default-label {
            background: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #202124;
            white-space: nowrap;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
            max-width: 110px;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .pinhole-marker:hover .marker-default-label {
            opacity: 1;
        }

        .pinhole-marker:hover .marker-circle {
            transform: scale(1.15);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.4);
        }

        .pinhole-marker .marker-active {
            position: absolute;
            left: 0;
            top: 0;
            transform: translate(-32px, -90px);
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .marker-balloon {
            width: 56px;
            height: 56px;
            border-radius: 50% 50% 50% 0;
            background: #1a73e8;
            transform: rotate(-45deg);
            border: 4px solid white;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .marker-balloon i {
            transform: rotate(45deg);
            color: white;
            font-size: 22px;
        }

        .marker-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #1a73e8;
            border: 2px solid white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
            margin-top: 4px;
        }

        .marker-active-label {
            margin-top: 4px;
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #202124;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pinhole-marker.active .marker-default {
            display: none;
        }

        .pinhole-marker.active .marker-active {
            display: flex;
            animation: pinPop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pinPop {
            0% {
                transform: translate(-32px, -90px) scale(0.4);
                opacity: 0;
            }

            60% {
                transform: translate(-32px, -90px) scale(1.08);
                opacity: 1;
            }

            100% {
                transform: translate(-32px, -90px) scale(1);
            }
        }

        /* ... (all other non-layout-specific styles like markers, popups, etc remain here) ... */

        /* ========== DESKTOP (>= 768px) ========== */
        @media (min-width: 768px) {
            .map-header {
                right: auto;
                width: 392px;
                flex-direction: column;
                background: none;
                box-shadow: none;
            }

            .search-box {
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                border-radius: 8px;
            }

            /* Directions box gets its own card on desktop */
            .directions-box {
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                margin-top: 8px;
                padding: 16px;
            }

            .directions-box .dir-dropdown {
                border-radius: 8px;
                margin-top: 4px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            }

            /* Search results card on desktop */
            .search-results {
                border-radius: 8px;
                margin-top: 8px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
                position: relative;
                top: 0;
            }

            /* Chips to right of search box */
            .chips-wrapper {
                top: 12px;
                left: 416px;
                right: 12px;
                height: auto;
            }

            .category-chips {
                padding: 0;
            }

            .category-chips .chip {
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            }

            .scroll-fade-left,
            .scroll-fade-right {
                display: none;
            }

            /* Mask-based fade for chips edges */
            .chips-wrapper.can-scroll-right .category-chips {
                -webkit-mask-image: linear-gradient(to right, black 0%, black calc(100% - 40px), transparent 100%);
                mask-image: linear-gradient(to right, black 0%, black calc(100% - 40px), transparent 100%);
            }

            .chips-wrapper.can-scroll-left .category-chips {
                -webkit-mask-image: linear-gradient(to right, transparent 0%, black 40px, black 100%);
                mask-image: linear-gradient(to right, transparent 0%, black 40px, black 100%);
            }

            .chips-wrapper.can-scroll-left.can-scroll-right .category-chips {
                -webkit-mask-image: linear-gradient(to right, transparent 0%, black 40px, black calc(100% - 40px), transparent 100%);
                mask-image: linear-gradient(to right, transparent 0%, black 40px, black calc(100% - 40px), transparent 100%);
            }

            /* Floating buttons on right side (Google Maps style) */
            .floating-btns {
                top: auto;
                bottom: 32px;
                left: auto;
                right: 60px;
                flex-direction: column;
            }

            /* Bottom sheet as side panel */
            .bottom-sheet {
                top: 12px;
                left: 12px;
                bottom: 12px;
                right: auto;
                width: 392px;
                max-height: none;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transform: translateX(-420px);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .bottom-sheet.expanded {
                transform: translateX(0);
            }

            /* When bottom sheet is open, push header right */
            .sheet-handle {
                display: none;
            }

            /* Nav overlay constrained on desktop */
            .nav-overlay {
                left: auto;
                right: 60px;
                width: 420px;
                border-radius: 0 0 16px 16px;
                top: 0;
            }
        }

        /* MISSING LOCATION LIST STYLES */
        .list-category {
            border-bottom: 1px solid #f1f3f4;
        }

        .category-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #fff;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #202124;
            font-weight: 500;
            transition: background 0.2s;
        }

        .category-toggle:hover {
            background: #f8f9fa;
        }

        .category-items {
            display: block;
        }

        .category-items.collapsed {
            display: none;
        }

        .location-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .location-item:hover {
            background: #f1f3f4;
        }

        .item-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 14px;
            flex-shrink: 0;
            color: white;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-info h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 2px;
            line-height: 1.4;
        }

        .item-info .arabic {
            font-family: 'Amiri', serif;
            font-size: 15px;
            color: #5f6368;
            margin-top: 2px;
            line-height: 1.4;
        }

        /* Holy Site Pills */
        .holy-site-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0 16px 12px;
        }

        .holy-site-pill {
            padding: 6px 12px;
            background: #f1f3f4;
            border: 1px solid white;
            border-radius: 16px;
            font-size: 13px;
            color: #3c4043;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .holy-site-pill:hover {
            background: #e8f0fe;
            color: #1a73e8;
        }

        /* Layer Control Positioning */
        .leaflet-top.leaflet-right {
            top: 70px !important;
        }

        /* Layer control panel styling */
        .leaflet-control-layers {
            border-radius: 8px !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25) !important;
            border: none !important;
        }

        /* Hide list completely when collapsed */
        .leaflet-control-layers-list {
            display: none;
        }

        .leaflet-control-layers-expanded .leaflet-control-layers-list {
            display: block;
            max-height: 45vh;
            overflow-y: auto;
            padding: 8px 12px;
        }

        /* Mobile layer control */
        @media (max-width: 767px) {
            .leaflet-top.leaflet-right {
                top: 130px !important;
                transition: top 0.3s ease;
            }

            /* Push layer control down when directions box is open */
            body.directions-open .leaflet-top.leaflet-right {
                top: 260px !important;
            }
        }

        /* ========== LOCK SCREEN ========== */
        #site-lock {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a3a2a 0%, #0d1f17 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s, visibility 0.5s;
        }

        #site-lock.unlocked {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .lock-card {
            background: white;
            border-radius: 16px;
            padding: 2.5rem 2rem;
            text-align: center;
            max-width: 360px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .lock-card h2 {
            margin-bottom: 0.5rem;
            color: #202124;
        }

        .lock-card p {
            color: #5f6368;
            font-size: 14px;
            margin-bottom: 1.5rem;
        }

        .lock-input-group {
            margin-bottom: 1rem;
        }

        .lock-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dadce0;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        .lock-input:focus {
            border-color: #1a73e8;
        }

        .lock-error {
            color: #ea4335;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        .lock-error.show {
            display: block;
        }

        .lock-btn {
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .lock-btn:hover {
            background: #1557b0;
        }

        /* ========== BACK BUTTON ========== */
        .back-btn {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #5f6368;
            font-size: 16px;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background: #f1f3f4;
        }

        /* ========== SEARCH RESULTS ========== */
        .search-results.active {
            display: block;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.15s;
            gap: 12px;
        }

        .search-result-item:hover {
            background: #f1f3f4;
        }

        .search-result-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: white;
            font-size: 13px;
        }

        .search-result-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-info .name {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-info .type {
            font-size: 12px;
            color: #5f6368;
        }

        /* ========== BOTTOM SHEET PARTS ========== */
        .sheet-handle {
            width: 36px;
            height: 4px;
            background: #dadce0;
            border-radius: 2px;
            margin: 8px auto;
            flex-shrink: 0;
        }

        .sheet-peek {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px 12px;
            border-bottom: 1px solid #f1f3f4;
            flex-shrink: 0;
        }

        .peek-title {
            font-size: 16px;
            font-weight: 600;
            color: #202124;
        }

        .peek-subtitle {
            font-size: 13px;
            color: #5f6368;
            margin-top: 2px;
        }

        .sheet-close-btn {
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #5f6368;
            font-size: 16px;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .sheet-close-btn:hover {
            background: #f1f3f4;
        }

        .sheet-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ========== LOCATION DETAIL ========== */
        .location-detail {
            display: none;
            padding: 16px;
        }

        .location-detail.active {
            display: block;
        }

        .detail-header {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 16px;
        }

        .detail-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }

        .detail-info {
            flex: 1;
            min-width: 0;
        }

        .detail-info h2 {
            font-size: 18px;
            font-weight: 600;
            color: #202124;
            margin: 0 0 2px;
        }

        .detail-info .arabic {
            font-family: 'Amiri', serif;
            font-size: 16px;
            color: #5f6368;
        }

        .detail-info p {
            font-size: 13px;
            color: #5f6368;
            margin-top: 4px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid #f1f3f4;
        }

        .action-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background: #1a73e8;
            color: white;
        }

        .action-btn.primary:hover {
            background: #1557b0;
        }

        .action-btn.secondary {
            background: #f1f3f4;
            color: #202124;
        }

        .action-btn.secondary:hover {
            background: #e8eaed;
        }

        /* ========== CATEGORY TOGGLE ICON ========== */
        .category-toggle .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #5f6368;
        }

        .category-toggle.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ========== NAV OVERLAY CHILDREN ========== */
        .nav-icon-large {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .nav-text {
            flex: 1;
            min-width: 0;
        }

        .nav-instruction {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .nav-sub-instruction {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 2px;
        }

        .nav-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .nav-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ========== LANDMARK MODAL ========== */
        .landmark-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .landmark-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid #f1f3f4;
        }

        .landmark-modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #202124;
            margin: 0;
        }

        .landmark-search {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f3f4;
        }

        .landmark-search input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .landmark-search input:focus {
            border-color: #1a73e8;
        }

        .landmark-list {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
            -webkit-overflow-scrolling: touch;
        }

        .landmark-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            gap: 12px;
            transition: background 0.15s;
        }

        .landmark-item:hover {
            background: #f1f3f4;
        }

        .landmark-item i {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e8f0fe;
            color: #1a73e8;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
        }

        .landmark-item-info {
            flex: 1;
            min-width: 0;
        }

        .landmark-item-info .name {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
        }

        .landmark-item-info .arabic {
            font-family: 'Amiri', serif;
            font-size: 13px;
            color: #5f6368;
        }

        /* ========== USER LOCATION PULSE ========== */
        .user-location-marker {
            background: none !important;
            border: none !important;
        }

        .pulse-dot {
            width: 14px;
            height: 14px;
            background: #4285f4;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 rgba(66, 133, 244, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(66, 133, 244, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(66, 133, 244, 0);
            }
        }

        /* ========== DIRECTION DROPDOWN ========== */
        .dir-input-wrapper {
            position: relative;
        }

        .dir-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1010;
            display: none;
        }

        .dir-dropdown.active {
            display: block;
        }

        .dir-dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            gap: 10px;
            font-size: 13px;
            color: #202124;
            transition: background 0.15s;
        }

        .dir-dropdown-item:hover {
            background: #f1f3f4;
        }

        .dir-dropdown-item.dir-myloc {
            color: #1a73e8;
            font-weight: 500;
            border-bottom: 1px solid #f1f3f4;
        }

        .dir-dropdown-item.dir-myloc i {
            color: #1a73e8;
        }

        .dir-dropdown-item i {
            color: #5f6368;
            font-size: 12px;
            width: 20px;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- Premium Lock Screen -->
    <div id="site-lock">
        <div class="lock-card">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üóùÔ∏è</div>
            <h2>Kunci Ibadah</h2>
            <p>Silakan masukkan kunci untuk membuka panduan Al Haramain.</p>
            <div class="lock-input-group">
                <input type="text" id="site-key" class="lock-input" placeholder="Masukkan kunci..." autocomplete="off">
                <div id="lock-error" class="lock-error">Kunci salah, silakan coba lagi.</div>
            </div>
            <button onclick="checkKey()" class="lock-btn">Buka Panduan</button>
        </div>
    </div>

    <script>
        function checkKey() {
            const input = document.getElementById('site-key').value.trim().toLowerCase();
            const lock = document.getElementById('site-lock');
            const error = document.getElementById('lock-error');

            if (input === 'al-fatihah') {
                lock.classList.add('unlocked');
                localStorage.setItem('site_unlocked', 'true');
            } else {
                error.classList.add('show');
                document.getElementById('site-key').value = '';
                setTimeout(() => error.classList.remove('show'), 3000);
            }
        }

        // Handle Enter key
        document.getElementById('site-key')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkKey();
        });

    </script>

    <!-- Google Maps Style Header -->
    <div class="map-header" id="mapHeader">
        <div class="search-box" id="searchBox">
            <button class="back-btn" onclick="window.location.href='index.html?unlocked=1'">
                <i class="fa fa-arrow-left"></i>
            </button>
            <div class="search-input-wrapper">
                <i class="fa fa-search"></i>
                <input type="text" id="searchInput" placeholder="Cari lokasi, gerbang, fasilitas..."
                    oninput="filterLocations()">
            </div>
            <button class="back-btn" style="box-shadow: none;" id="directionsToggleBtn" onclick="toggleDirections()">
                <i class="fa fa-directions"></i>
            </button>
        </div>
        <div class="search-results" id="searchResults"></div>

        <!-- Directions Search Box (Inside Header to keep it stable) -->
        <div class="directions-box" id="directionsBox">
            <div class="dir-input-group">
                <div class="dir-dots">
                    <div class="dot-start"></div>
                    <div class="dot-line"></div>
                    <div class="dot-end"></div>
                </div>
                <div class="dir-inputs">
                    <div class="dir-input-wrapper">
                        <input type="text" id="startInput" placeholder="Cari titik awal..."
                            oninput="filterDirLocations('start')" onfocus="filterDirLocations('start')">
                        <button class="pick-btn" onclick="setPickMode('start')" title="Pilih di Peta"><i
                                class="fa fa-map-pin"></i></button>
                        <div class="dir-dropdown" id="startDropdown"></div>
                    </div>
                    <div class="dir-input-wrapper">
                        <input type="text" id="endInput" placeholder="Cari tujuan..."
                            oninput="filterDirLocations('end')" onfocus="filterDirLocations('end')">
                        <button class="pick-btn" onclick="setPickMode('end')" title="Pilih di Peta"><i
                                class="fa fa-map-pin"></i></button>
                        <div class="dir-dropdown" id="endDropdown"></div>
                    </div>
                </div>
            </div>
            <div class="dir-actions">
                <span id="routeInfo" style="font-size: 13px; color: #5f6368;">Pilih lokasi di peta atau dari
                    daftar</span>
                <div style="display: flex; gap: 8px;">
                    <button class="nav-btn-start" id="routeBtn" onclick="calculateRoute()">Cari Rute</button>
                    <button class="nav-btn-start" id="startNavBtn" style="display: none; background: #34a853;"
                        onclick="startNavigation()">Mulai</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Chips Outside Header for floating effect -->
    <!-- Category Chips Outside Header for floating effect -->
    <div class="chips-wrapper" id="chipsWrapper">
        <div class="category-chips" id="categoryChips">
            <div class="chip active" data-category="all"><i class="fa fa-globe"></i> Semua</div>
            <div class="chip" data-category="Holy Site"><i class="fa fa-kaaba"></i> Holy Site</div>
            <div class="chip" data-category="Mosque"><i class="fa fa-mosque"></i> Masjid</div>
            <div class="chip" data-category="Gate"><i class="fa fa-door-open"></i> Gerbang</div>
            <div class="chip" data-category="Hotel"><i class="fa fa-hotel"></i> Hotel</div>
            <div class="chip" data-category="W C"><i class="fa fa-restroom"></i> WC</div>
            <div class="chip" data-category="Medical"><i class="fa fa-hospital"></i> Medis</div>
            <div class="chip" data-category="Food"><i class="fa fa-utensils"></i> Makanan</div>
            <div class="chip" data-category="Zamzam/Water"><i class="fa fa-tint"></i> Zamzam</div>
            <div class="chip" data-category="Transportation"><i class="fa fa-bus"></i> Transportasi</div>
            <div class="chip" data-category="Landmark"><i class="fa fa-map-marker-alt"></i> Landmark</div>
        </div>
        <div class="scroll-fade-left"></div>
        <div class="scroll-fade-right"></div>
    </div>

    <!-- Apple Maps Style Navigation Overlay -->
    <div class="nav-overlay" id="navOverlay">
        <div class="nav-icon-large" id="navIcon">
            <i class="fa fa-arrow-up"></i>
        </div>
        <div class="nav-text">
            <div class="nav-instruction" id="navMainText">Lurus terus</div>
            <div class="nav-sub-instruction" id="navSubText">Tetap di jalur</div>
        </div>
        <div style="text-align: right; margin-right: 10px;">
            <div id="navDistance" style="font-size: 20px; font-weight: bold; color: #1a73e8;">0 m</div>
        </div>
        <button class="nav-close-btn" onclick="stopNavigation()">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- Floating Buttons -->
    <div class="floating-btns" id="floatingBtns">
        <button class="fab-btn" id="sheetToggleBtn" onclick="toggleBottomSheet()" title="Daftar Lokasi">
            <i class="fa fa-bars"></i>
        </button>
        <button class="fab-btn kaaba" id="centerHaramBtn" onclick="goToHaramCenter()" title="Ke Ka'bah">
            <i class="fa fa-kaaba"></i>
        </button>
    </div>

    <!-- Bottom Sheet -->
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-handle" id="sheetHandle"></div>
        <div class="sheet-peek" id="sheetPeek">
            <div>
                <div class="peek-title">Masjidil Haram</div>
                <div class="peek-subtitle">Daftar lokasi penting</div>
            </div>
            <button class="sheet-close-btn" onclick="closeBottomSheet()" title="Tutup">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="sheet-content" id="sheetContent">
            <div id="locationDetail" class="location-detail"></div>
            <div id="locationsList" class="locations-list"></div>
        </div>
    </div>

    <!-- Landmark Modal -->
    <div class="landmark-modal" id="landmarkModal">
        <div class="landmark-modal-content">
            <div class="landmark-modal-header">
                <h3>Pilih Landmark</h3>
                <button onclick="closeLandmarkModal()"
                    style="background:none; border:none; font-size:20px; cursor:pointer; color:#5f6368;">&times;</button>
            </div>
            <div class="landmark-search">
                <input type="text" id="landmarkSearch" placeholder="Cari landmark..." onkeyup="filterLandmarks()">
            </div>
            <div class="landmark-list" id="landmarkList"></div>
        </div>
    </div>

    <div id="map"></div>

    <!-- Data & Scripts -->
    <script src="masjidil-haram-data.js"></script>
    <script src="osm_data/haram-routing-graph-v2.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // ========== STATE ==========
        let startPoint = null;
        let endPoint = null;
        let startMarker = null;
        let endMarker = null;
        let routeLayer = null;
        let pickingMode = null;
        let navigationActive = false;
        let currentPath = [];
        let navigationSteps = [];
        let landmarkPickingType = 'start';
        let activeMarker = null;
        let allMarkers = [];
        let activeCategory = 'all';

        // ========== MAP INIT ==========
        const map = L.map('map', {
            zoomControl: false,
            center: [21.4245, 39.8227],
            zoom: 17,
            maxZoom: 19,
            minZoom: 13
        });

        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Base Layers
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 19
        });

        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        });

        const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
            zIndex: 1000,
            maxZoom: 20
        });

        satellite.addTo(map);

        const baseMaps = { "Satelit": satellite, "Peta Biasa (OSM)": osmLayer };
        const overlayMaps = { "Label": labels };
        window.layerControl = L.control.layers(baseMaps, overlayMaps, { position: 'topright' }).addTo(map);

        // Color mapping
        const markerColors = {
            'Holy Site': '#d4af37',
            'Mosque': '#2e7d32',
            'Main Gate': '#064e3b',
            'Gate': '#3498db',
            'Hotel': '#8e44ad',
            'Medical': '#e67e22',
            'W C': '#06b6d4',
            'Food': '#10b981',
            'Zamzam/Water': '#3b82f6',
            'Elevator': '#8b5cf6',
            'Escalator': '#ec4899',
            'Stairs': '#f97316',
            'Transportation': '#6366f1',
            'Amenities': '#f59e0b',
            'Support': '#475569',
            'Landmark': '#e74c3c'
        };
        const categoryIcons = {
            'all': 'fa-globe', 'Holy Site': 'fa-kaaba', 'Mosque': 'fa-mosque',
            'Main Gate': 'fa-archway', 'Gate': 'fa-door-open', 'W C': 'fa-restroom',
            'Zamzam/Water': 'fa-tint', 'Medical': 'fa-hospital', 'Transportation': 'fa-bus',
            'Hotel': 'fa-hotel', 'Food': 'fa-utensils', 'Amenities': 'fa-cogs',
            'Escalator': 'fa-arrows-alt-v', 'Elevator': 'fa-arrows-alt-v',
            'Stairs': 'fa-shoe-prints', 'Support': 'fa-life-ring', 'Landmark': 'fa-map-marker-alt'
        };

        const markersLayer = L.layerGroup().addTo(map);
        const clusterGroup = L.markerClusterGroup({
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            spiderfyOnMaxZoom: true,
            maxClusterRadius: 50
        }).addTo(map);

        // Extra layers (Roads & Buildings)
        const roadsLayer = L.featureGroup();
        const buildingsLayer = L.featureGroup();

        if (window.layerControl) {
            window.layerControl.addOverlay(markersLayer, "Points of Interest");
            window.layerControl.addOverlay(clusterGroup, "Facilities (Clustered)");
            window.layerControl.addOverlay(roadsLayer, "Roads / Jalur");
            window.layerControl.addOverlay(buildingsLayer, "Buildings / Bangunan");
        }

        // ========== GPS ==========
        L.Control.Gps = L.Control.extend({
            onAdd: function (map) {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                div.innerHTML = '<a href="#" title="Lokasi Saya" style="font-size: 18px; display: flex; align-items: center; justify-content: center; width: 34px; height: 34px;"><i class="fa fa-crosshairs"></i></a>';
                div.style.cursor = 'pointer';
                div.onclick = function (e) {
                    e.preventDefault();
                    map.locate({ setView: true, maxZoom: 18 });
                };
                return div;
            }
        });
        new L.Control.Gps({ position: 'bottomright' }).addTo(map);

        map.locate({ setView: true, maxZoom: 18 });

        map.on('locationfound', function (e) {
            if (navigationActive) {
                let minDiv = Infinity;
                let nearestIdx = 0;
                currentPath.forEach((p, idx) => {
                    const d = map.distance(e.latlng, p);
                    if (d < minDiv) { minDiv = d; nearestIdx = idx; }
                });
                updateNavigationUI(nearestIdx);
                // Also update user pulse marker if exists
                if (window.userPulseMarker) window.userPulseMarker.setLatLng(e.latlng);
                else {
                    const pulseIcon = L.divIcon({
                        className: 'user-location-marker',
                        html: '<div class="pulse-dot"></div>',
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    });
                    window.userPulseMarker = L.marker(e.latlng, { icon: pulseIcon }).addTo(map);
                }
                return;
            }
            const radius = e.accuracy / 2;

            if (window.userPulseMarker) window.userPulseMarker.setLatLng(e.latlng);
            else {
                const pulseIcon = L.divIcon({
                    className: 'user-location-marker',
                    html: '<div class="pulse-dot"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
                window.userPulseMarker = L.marker(e.latlng, { icon: pulseIcon }).addTo(map);
            }

            if (window.userAccuracyCircle) window.userAccuracyCircle.setLatLng(e.latlng).setRadius(radius);
            else window.userAccuracyCircle = L.circle(e.latlng, radius, { color: '#1a73e8', weight: 1, fillOpacity: 0.1 }).addTo(map);
        });

        // ========== PINHOLE MARKERS ==========
        function createPinholeMarker(feature) {
            let type = feature.properties.type;
            let color = markerColors[type] || '#1a73e8';
            const categoryClass = type.toLowerCase().replace(/ /g, '-');
            let iconClass = feature.properties.icon || 'fa-map-marker';
            const name = feature.properties.name_en || feature.properties.name;

            // --- CUSTOM: 5 MAIN GATES ---
            const mainGateOsmIds = [
                '4755914231', // King Abdul Aziz Gate 1
                '3210622327', // King Fahd Gate 79
                '5875587679', // King Abdullah Gate 100
                '6301219294', // Bab Al-Salam (Gate 24)
                '4318154228'  // Umra Gate 40 (or 62)
            ];

            if (mainGateOsmIds.includes(String(feature.properties.osm_id))) {
                iconClass = 'fa-archway'; // Distinct icon for main gates
                color = markerColors['Main Gate'];
            }

            const icon = L.divIcon({
                className: 'pinhole-marker',
                html: `
                    <div class="marker-wrapper">
                        <div class="marker-default">
                            <div class="marker-circle" style="background: ${color};">
                                <i class="fa ${iconClass}"></i>
                            </div>
                            <div class="marker-default-label">${name}</div>
                        </div>
                        <div class="marker-active">
                            <div class="marker-balloon" style="background: ${color};">
                                <i class="fa ${iconClass}"></i>
                            </div>
                            <div class="marker-dot" style="background: ${color};"></div>
                            <div class="marker-active-label">${name}</div>
                        </div>
                    </div>
                `,
                iconSize: [0, 0],
                iconAnchor: [0, 0]
            });

            const coords = feature.geometry.coordinates;
            const marker = L.marker([coords[1], coords[0]], { icon: icon });

            marker.on('click', function () {
                showLocationDetail(feature, marker);
                if (activeMarker && activeMarker !== marker) {
                    const el = activeMarker.getElement();
                    if (el) el.classList.remove('active');
                }
                const el = marker.getElement();
                if (el) el.classList.add('active');
                activeMarker = marker;
                map.flyTo([coords[1], coords[0]], 18);
            });

            allMarkers.push({ marker, feature });
            return marker;
        }

        // ========== BOTTOM SHEET ==========
        function showLocationDetail(feature, marker) {
            // Deactivate previous active marker
            if (activeMarker) {
                const el = activeMarker.getElement();
                if (el) el.classList.remove('active');
            }

            // Activate new marker
            activeMarker = marker;
            const el = marker.getElement();
            if (el) el.classList.add('active');

            const props = feature.properties;
            const type = props.type;
            const color = markerColors[type] || '#1a73e8';
            const coords = feature.geometry.coordinates;

            const detailHTML = `
                <button onclick="resetBottomSheet()" style="background:none; border:none; cursor:pointer; padding:4px 0; margin-bottom:12px; display:flex; align-items:center; gap:6px; color:#1a73e8; font-size:14px; font-weight:500;">
                    <i class="fa fa-chevron-left" style="font-size:12px;"></i> Kembali ke daftar
                </button>
                <div class="detail-header">
                    <div class="detail-icon" style="background: ${color};">
                        <i class="fa ${props.icon || 'fa-map-marker-alt'}"></i>
                    </div>
                    <div class="detail-info">
                        <h2>${props.name_en || props.name}</h2>
                        <span class="arabic">${props.name}</span>
                        <p>${type} &middot; Lantai ${props.floor || 'Dasar'}</p>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="routeToLocation([${coords[1]}, ${coords[0]}], '${(props.name_en || props.name).replace(/'/g, "\\'")}')">
                        <i class="fa fa-directions"></i> Rute
                    </button>
                    <button class="action-btn secondary" onclick="shareLocation('${(props.name_en || props.name).replace(/'/g, "\\'")}')">
                        <i class="fa fa-share"></i> Bagikan
                    </button>
                </div>
            `;

            const detailEl = document.getElementById('locationDetail');
            if (detailEl) {
                detailEl.innerHTML = detailHTML;
                detailEl.classList.add('active');
                const listEl = document.getElementById('locationsList');
                if (listEl) listEl.style.display = 'none';
                openBottomSheet();
            }
        }


        function resetBottomSheet() {
            document.getElementById('locationDetail').classList.remove('active');
            document.getElementById('locationDetail').innerHTML = '';
            document.getElementById('locationsList').style.display = '';
            if (activeMarker) {
                const el = activeMarker.getElement();
                if (el) el.classList.remove('active');
                activeMarker = null;
            }
        }

        // ========== LOCATIONS LIST ==========
        const categoryLabels = {
            'Holy Site': 'Holy Site', 'Mosque': 'Masjid', 'Main Gate': 'Pintu Utama',
            'Gate': 'Gerbang', 'W C': 'WC', 'Zamzam/Water': 'Zamzam',
            'Medical': 'Medis', 'Transportation': 'Transportasi', 'Hotel': 'Hotel',
            'Food': 'Makanan', 'Amenities': 'Fasilitas', 'Escalator': 'Eskalator',
            'Elevator': 'Lift', 'Stairs': 'Tangga', 'Support': 'Support', 'Landmark': 'Landmark'
        };


        function renderLocationsList(data) {
            data = data || masjidilHaramLocations;
            const grouped = {};
            data.forEach(item => {
                const t = item.properties.type;
                if (!grouped[t]) grouped[t] = [];
                grouped[t].push(item);
            });

            const typeOrder = [
                'Holy Site', 'Mosque', 'Main Gate', 'Gate',
                'W C', 'Zamzam/Water', 'Medical', 'Transportation',
                'Hotel', 'Food', 'Amenities',
                'Escalator', 'Elevator', 'Stairs',
                'Support', 'Landmark'
            ];

            let html = '';
            typeOrder.forEach(type => {
                if (!grouped[type]) return;
                const color = markerColors[type] || '#475569';
                const label = categoryLabels[type] || type;
                const catIcon = categoryIcons[type] || 'fa-folder';
                const sectionId = type.replace(/[\/ ]/g, '-');

                // Header with accordion toggle (collapsed by default)
                html += `<div class="list-category">
                    <button class="category-toggle collapsed" onclick="toggleSection('${sectionId}', this)">
                        <div class="category-header" style="margin-bottom:0;">
                            <i class="fa ${catIcon}" style="color:${color};"></i> ${label} (${grouped[type].length})
                        </div>
                        <i class="fa fa-chevron-down toggle-icon"></i>
                    </button>`;

                // Holy Site rendered as pills
                if (type === 'Holy Site') {
                    html += `<div class="category-items collapsed" id="section-${sectionId}">
                        <div class="holy-site-pills" style="margin-top:10px;">`;
                    grouped[type].forEach(item => {
                        html += `<div class="holy-site-pill" onclick="selectLocation('${item.properties.osm_id}')">
                            <i class="fa ${item.properties.icon || 'fa-kaaba'}"></i>
                            ${item.properties.name_en || item.properties.name}
                        </div>`;
                    });
                    html += `</div></div></div>`;
                    return;
                }

                // Regular items (collapsed by default)
                html += `<div class="category-items collapsed" id="section-${sectionId}">`;
                grouped[type].forEach(item => {
                    const nameEn = item.properties.name_en || item.properties.name;
                    const nameAr = item.properties.name;
                    // Only show Arabic if it's different and actually looks like Arabic
                    const showArabic = nameAr && nameAr !== nameEn && /[\u0600-\u06FF]/.test(nameAr);

                    html += `
                        <div class="location-item" onclick="selectLocation('${item.properties.osm_id}')">
                            <div class="item-icon" style="background: ${color};">
                                <i class="fa ${item.properties.icon}"></i>
                            </div>
                            <div class="item-info">
                                <h3>${nameEn}</h3>
                                ${showArabic ? `<div class="arabic">${nameAr}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            });

            document.getElementById('locationsList').innerHTML = html;
        }

        function toggleSection(sectionId, btnEl) {
            const items = document.getElementById('section-' + sectionId);
            if (!items) return;
            items.classList.toggle('collapsed');
            btnEl.classList.toggle('collapsed');
        }

        function goToHaramCenter() {
            map.flyTo([21.4225, 39.8262], 18);
        }

        function selectLocation(osmId) {
            // Close search results and dropdowns
            document.getElementById('searchResults').classList.remove('active');
            closeDirDropdowns();

            const item = allMarkers.find(m => m.feature.properties.osm_id === osmId);
            if (item) item.marker.fire('click');
        }

        // ========== SEARCH & FILTER ==========
        function filterLocations() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const searchResults = document.getElementById('searchResults');
            let filteredData = masjidilHaramLocations;

            // Apply category filter FIRST
            if (activeCategory !== 'all') {
                filteredData = filteredData.filter(loc => loc.properties.type === activeCategory);
            }

            // Then, apply search query on the (potentially category-filtered) data
            if (query.length > 0) {
                filteredData = filteredData.filter(loc =>
                    (loc.properties.name || '').toLowerCase().includes(query) ||
                    (loc.properties.name_en || '').toLowerCase().includes(query) ||
                    (loc.properties.type || '').toLowerCase().includes(query)
                );
                populateSearchResults(filteredData.slice(0, 8));
                searchResults.classList.add('active');
            } else {
                searchResults.innerHTML = '';
                searchResults.classList.remove('active');
            }

            // Sync map, list, and chips
            renderLocationsList(filteredData);
            filterMapMarkersByData(filteredData);
            updateCategoryChips(masjidilHaramLocations, query); // Update chips based on original data + query
        }

        function updateCategoryChips(sourceData, query) {
            const chipsContainer = document.getElementById('categoryChips');
            const relevantCats = new Set(['all']);

            // If there's a search query, find which categories are in the results
            if (query) {
                sourceData.forEach(loc => {
                    if ((loc.properties.name || '').toLowerCase().includes(query) ||
                        (loc.properties.name_en || '').toLowerCase().includes(query)) {
                        relevantCats.add(loc.properties.type);
                    }
                });
            } else { // Otherwise, all categories are relevant
                sourceData.forEach(loc => relevantCats.add(loc.properties.type));
            }

            const sortedCats = ['all', ...Object.keys(categoryIcons).filter(c => c !== 'all' && relevantCats.has(c))];

            chipsContainer.innerHTML = sortedCats.map(cat => `
                <div class="chip ${cat === activeCategory ? 'active' : ''}" data-category="${cat}">
                    <i class="fa ${categoryIcons[cat] || 'fa-info-circle'}"></i> ${cat}
                </div>
            `).join('');

            // Re-add event listeners
            chipsContainer.querySelectorAll('.chip').forEach(chip => {
                chip.addEventListener('click', function () {
                    activeCategory = this.dataset.category;
                    // No need to remove/add active class here, filterLocations will re-render
                    filterLocations();
                });
            });
        }

        function populateSearchResults(results) {
            const container = document.getElementById('searchResults');
            if (!container) return;

            if (results.length === 0) {
                container.innerHTML = '<div class="search-result-item" style="color:#5f6368; justify-content:center;">Tidak ditemukan</div>';
                return;
            }

            let html = '';
            results.forEach(item => {
                const props = item.properties;
                const type = props.type;
                const color = markerColors[type] || '#1a73e8';
                const icon = props.icon || 'fa-map-marker';

                html += `
                    <div class="search-result-item" onclick="selectLocation('${props.osm_id}')">
                        <div class="search-result-icon" style="background: ${color};">
                            <i class="fa ${icon}"></i>
                        </div>
                        <div class="search-result-info">
                            <div class="name">${props.name_en || props.name}</div>
                            <div class="type">${type}</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function filterMapMarkersByData(filteredData) {
            markersLayer.clearLayers();
            clusterGroup.clearLayers();

            const filteredOsmIds = new Set(filteredData.map(loc => loc.properties.osm_id));
            const clusterTypesList = ['Support', 'Hotel', 'Landmark', 'Transportation', 'Food', 'Holy Site', 'Mosque', 'W C'];

            allMarkers.forEach(({ marker, feature }) => {
                if (filteredOsmIds.has(feature.properties.osm_id)) {
                    const type = feature.properties.type;
                    if (clusterTypesList.includes(type)) {
                        clusterGroup.addLayer(marker);
                    } else {
                        markersLayer.addLayer(marker);
                    }
                }
            });
        }


        // ========== BOTTOM SHEET TOGGLE ==========
        let startY = 0;
        const sheet = document.getElementById('bottomSheet');
        const handle = document.getElementById('sheetHandle');
        const peek = document.getElementById('sheetPeek');
        const toggleBtn = document.getElementById('sheetToggleBtn');

        function toggleBottomSheet() {
            if (sheet.classList.contains('expanded')) {
                closeBottomSheet();
            } else {
                openBottomSheet();
            }
        }

        function openBottomSheet() {
            sheet.classList.add('expanded');
            toggleBtn.style.display = 'none';
        }

        function closeBottomSheet() {
            sheet.classList.remove('expanded');
            toggleBtn.style.display = '';
            // Reset detail view if open
            document.getElementById('locationDetail').classList.remove('active');
            document.getElementById('locationDetail').innerHTML = '';
            document.getElementById('locationsList').style.display = '';
            if (activeMarker) {
                const el = activeMarker.getElement();
                if (el) el.classList.remove('active');
                activeMarker = null;
            }
        }

        // Drag to close on mobile (works on handle and peek area)
        let sheetDragging = false;
        function initSheetDrag(el) {
            el.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                sheetDragging = true;
                sheet.style.transition = 'none';
            }, { passive: true });
            el.addEventListener('touchmove', (e) => {
                if (!sheetDragging) return;
                const diff = e.touches[0].clientY - startY;
                if (diff > 0) {
                    sheet.style.transform = `translateY(${diff}px)`;
                }
            }, { passive: true });
            el.addEventListener('touchend', (e) => {
                if (!sheetDragging) return;
                sheetDragging = false;
                sheet.style.transition = '';
                const diff = e.changedTouches[0].clientY - startY;
                if (diff > 80) {
                    closeBottomSheet();
                } else {
                    sheet.style.transform = '';
                }
            });
        }
        initSheetDrag(handle);
        initSheetDrag(peek);

        // Double-tap to close on mobile
        let lastTapTime = 0;
        sheet.addEventListener('touchend', (e) => {
            if (sheetDragging) return;
            const now = Date.now();
            if (now - lastTapTime < 300) {
                e.preventDefault();
                closeBottomSheet();
                lastTapTime = 0;
            } else {
                lastTapTime = now;
            }
        });

        // ========== DIRECTIONS TOGGLE ==========
        function toggleDirections() {
            const box = document.getElementById('directionsBox');
            const btn = document.getElementById('directionsToggleBtn');
            if (box.classList.contains('active')) {
                exitDirections();
            } else {
                box.classList.add('active');
                btn.innerHTML = '<i class="fa fa-times"></i>';
                document.getElementById('categoryChips').style.display = 'none';
                document.body.classList.add('directions-open');
            }
        }

        function exitDirections() {
            document.getElementById('directionsBox').classList.remove('active');
            document.getElementById('directionsToggleBtn').innerHTML = '<i class="fa fa-directions"></i>';
            document.getElementById('categoryChips').style.display = '';
            document.body.classList.remove('directions-open');
            closeDirDropdowns();
            // Clean up route
            if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
            if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
            if (endMarker) { map.removeLayer(endMarker); endMarker = null; }
            startPoint = null; endPoint = null;
            document.getElementById('startInput').value = '';
            document.getElementById('endInput').value = '';
            document.getElementById('routeInfo').textContent = 'Pilih lokasi di peta atau dari daftar';
            document.getElementById('startNavBtn').style.display = 'none';
            currentPath = [];
        }

        // Route to location from detail view
        function routeToLocation(coords, name) {
            // Open directions box
            const box = document.getElementById('directionsBox');
            if (!box.classList.contains('active')) {
                box.classList.add('active');
                document.getElementById('directionsToggleBtn').innerHTML = '<i class="fa fa-times"></i>';
                document.getElementById('categoryChips').style.display = 'none';
            }
            // coords is [lat, lng] from template
            const latlng = L.latLng(coords[0], coords[1]);
            setEndPoint(latlng, name);
            // Collapse bottom sheet
            closeBottomSheet();
        }

        // ========== ROUTING POINTS ==========
        function setStartPoint(latlng, name) {
            if (startMarker) map.removeLayer(startMarker);
            startMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'pinhole-marker',
                    html: '<div style="background:#34a853;width:14px;height:14px;border-radius:50%;border:3px solid white;box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                })
            }).addTo(map);
            startPoint = latlng;
            document.getElementById('startInput').value = name;
            updateRouteInfo();
        }

        function setEndPoint(latlng, name) {
            if (endMarker) map.removeLayer(endMarker);
            endMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'pinhole-marker',
                    html: '<div style="background:#ea4335;width:14px;height:14px;border-radius:50%;border:3px solid white;box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                })
            }).addTo(map);
            endPoint = latlng;
            document.getElementById('endInput').value = name;
            updateRouteInfo();
        }

        function updateRouteInfo() {
            const info = document.getElementById('routeInfo');
            if (startPoint && endPoint) {
                info.textContent = 'Siap cari rute';
            } else if (startPoint) {
                info.textContent = 'Pilih tujuan...';
            } else if (endPoint) {
                info.textContent = 'Pilih titik awal...';
            }
        }

        // ========== PICK MODE (MAP CLICK) ==========
        function setPickMode(mode) {
            pickingMode = mode;
            document.getElementById('map').style.cursor = 'crosshair';
            const type = mode === 'start' ? 'Awal' : 'Tujuan';
            document.getElementById('routeInfo').textContent = `Klik di peta untuk Titik ${type}...`;
        }

        map.on('click', function (e) {
            // Close search dropdown on map click
            document.getElementById('searchResults').classList.remove('active');
            closeDirDropdowns();

            if (!pickingMode) return;
            const name = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
            if (pickingMode === 'start') {
                setStartPoint(e.latlng, name);
            } else if (pickingMode === 'end') {
                setEndPoint(e.latlng, name);
            }
            document.getElementById('map').style.cursor = '';
            pickingMode = null;
        });

        // ========== LANDMARK MODAL ==========
        function openLandmarkModal(type) {
            landmarkPickingType = type;
            document.getElementById('landmarkModal').classList.add('active');
            document.getElementById('landmarkSearch').value = '';
            renderLandmarks();
        }

        function closeLandmarkModal() {
            document.getElementById('landmarkModal').classList.remove('active');
        }

        function renderLandmarks() {
            const list = document.getElementById('landmarkList');
            const search = (document.getElementById('landmarkSearch').value || '').toLowerCase();
            list.innerHTML = '';

            const filtered = masjidilHaramLocations.filter(loc =>
                (loc.properties.name || '').toLowerCase().includes(search) ||
                (loc.properties.name_en || '').toLowerCase().includes(search)
            ).slice(0, 50);

            filtered.forEach(loc => {
                const item = document.createElement('div');
                item.className = 'landmark-item';
                item.innerHTML = `
                    <i class="fa ${loc.properties.icon || 'fa-map-marker-alt'}"></i>
                    <div class="landmark-item-info">
                        <div class="name">${loc.properties.name_en || loc.properties.name}</div>
                        <div class="arabic">${loc.properties.name}</div>
                    </div>
                `;
                item.onclick = () => selectLandmark(loc);
                list.appendChild(item);
            });
        }

        function filterLandmarks() { renderLandmarks(); }

        // ========== DIRECTION DROPDOWNS ==========
        function filterDirLocations(type) {
            const inputId = type === 'start' ? 'startInput' : 'endInput';
            const dropdownId = type === 'start' ? 'startDropdown' : 'endDropdown';
            const query = document.getElementById(inputId).value.toLowerCase();
            const dropdown = document.getElementById(dropdownId);

            // "Lokasi Saya" always at top
            let html = `<div class="dir-dropdown-item dir-myloc" onclick="selectMyLocation('${type}')">
                <i class="fa fa-crosshairs"></i>
                <span>Lokasi Saya</span>
            </div>`;

            let filtered = masjidilHaramLocations;
            if (query) {
                filtered = filtered.filter(loc =>
                    (loc.properties.name || '').toLowerCase().includes(query) ||
                    (loc.properties.name_en || '').toLowerCase().includes(query)
                );
            }
            filtered = filtered.slice(0, 10);

            if (filtered.length === 0 && query) {
                html += '<div class="dir-dropdown-item" style="color:#5f6368; justify-content:center;">Tidak ditemukan</div>';
            } else {
                html += filtered.map(loc => {
                    const name = loc.properties.name_en || loc.properties.name;
                    const icon = loc.properties.icon || 'fa-map-marker-alt';
                    return `<div class="dir-dropdown-item" onclick="selectDirLocation('${type}', '${loc.properties.osm_id}')">
                        <i class="fa ${icon}"></i>
                        <span>${name}</span>
                    </div>`;
                }).join('');
            }
            dropdown.innerHTML = html;
            dropdown.classList.add('active');
        }

        function selectMyLocation(type) {
            if (window.userPulseMarker) {
                const latlng = window.userPulseMarker.getLatLng();
                if (type === 'start') {
                    setStartPoint(latlng, 'Lokasi Saya');
                } else {
                    setEndPoint(latlng, 'Lokasi Saya');
                }
                closeDirDropdowns();
            } else {
                map.locate({ setView: false, maxZoom: 18 });
                map.once('locationfound', function (e) {
                    if (type === 'start') {
                        setStartPoint(e.latlng, 'Lokasi Saya');
                    } else {
                        setEndPoint(e.latlng, 'Lokasi Saya');
                    }
                    closeDirDropdowns();
                });
                map.once('locationerror', function () {
                    alert('Gagal mendapatkan lokasi. Pastikan GPS aktif.');
                });
            }
        }

        function selectDirLocation(type, osmId) {
            const loc = masjidilHaramLocations.find(l => l.properties.osm_id === osmId);
            if (!loc) return;
            const coords = loc.geometry.coordinates;
            const latlng = L.latLng(coords[1], coords[0]);
            const name = loc.properties.name_en || loc.properties.name;

            if (type === 'start') {
                setStartPoint(latlng, name);
            } else {
                setEndPoint(latlng, name);
            }
            closeDirDropdowns();
            map.setView(latlng, 18);
        }

        function closeDirDropdowns() {
            document.getElementById('startDropdown').classList.remove('active');
            document.getElementById('endDropdown').classList.remove('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.dir-input-wrapper')) {
                closeDirDropdowns();
            }
            if (!e.target.closest('.map-header')) {
                document.getElementById('searchResults').classList.remove('active');
            }
        });

        function selectLandmark(loc) {
            const coords = loc.geometry.coordinates;
            const latlng = L.latLng(coords[1], coords[0]);
            const name = loc.properties.name_en || loc.properties.name;

            if (landmarkPickingType === 'start') {
                setStartPoint(latlng, name);
            } else {
                setEndPoint(latlng, name);
            }
            closeLandmarkModal();
            map.setView(latlng, 18);
        }

        // ========== NAVIGATION & ROUTING LOGIC ==========

        // Priority Queue for Dijkstra
        class PriorityQueue {
            constructor() { this.values = []; }
            enqueue(val, priority) {
                this.values.push({ val, priority });
                this.sort();
            }
            dequeue() { return this.values.shift(); }
            sort() { this.values.sort((a, b) => a.priority - b.priority); }
        }

        // Dijkstra Algorithm
        function dijkstra(startNode, endNode) {
            const nodes = routingGraph.nodes;
            const adjacency = routingGraph.adj;

            const distances = {};
            const previous = {};
            const pq = new PriorityQueue();

            // Initialize
            for (let node in nodes) {
                if (node === startNode) {
                    distances[node] = 0;
                    pq.enqueue(node, 0);
                } else {
                    distances[node] = Infinity;
                    pq.enqueue(node, Infinity);
                }
                previous[node] = null;
            }

            while (pq.values.length) {
                let smallest = pq.dequeue().val;
                if (smallest === endNode) {
                    // Build path
                    const path = [];
                    while (previous[smallest]) {
                        path.push(nodes[smallest]);
                        smallest = previous[smallest];
                    }
                    path.push(nodes[smallest]); // Add start
                    return path.reverse();
                }

                if (smallest || distances[smallest] !== Infinity) {
                    for (let neighbor in adjacency[smallest]) {
                        let nextNode = neighbor;
                        let weight = adjacency[smallest][neighbor];
                        let candidate = distances[smallest] + weight;

                        if (candidate < distances[nextNode]) {
                            distances[nextNode] = candidate;
                            previous[nextNode] = smallest;
                            pq.enqueue(nextNode, candidate);
                        }
                    }
                }
            }
            return null;
        }

        function findNearestNode(lat, lng) {
            let minC = Infinity;
            let nearest = null;
            for (let node in routingGraph.nodes) {
                const [nLat, nLng] = routingGraph.nodes[node];
                const d = Math.sqrt((lat - nLat) ** 2 + (lng - nLng) ** 2);
                if (d < minC) {
                    minC = d;
                    nearest = node;
                }
            }
            return nearest;
        }

        function startNavigation() {
            if (!currentPath || currentPath.length === 0) return;
            navigationActive = true;
            document.getElementById('navOverlay').classList.add('active');

            // Hide other UI elements to focus on navigation
            document.getElementById('mapHeader').style.display = 'none';
            document.getElementById('categoryChips').style.display = 'none';
            document.getElementById('floatingBtns').style.display = 'none';

            // Generate initial instructions
            generateInstructions(currentPath);
            updateNavigationUI(0);

            // Zoom to start
            if (currentPath[0]) {
                map.flyTo(currentPath[0], 19, { animate: true, duration: 1.5 });
            }
        }

        function stopNavigation() {
            navigationActive = false;
            document.getElementById('navOverlay').classList.remove('active');

            // Restore UI
            document.getElementById('mapHeader').style.display = '';
            document.getElementById('categoryChips').style.display = '';
            document.getElementById('floatingBtns').style.display = '';

            // Zoom back to show route
            if (routeLayer) map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
        }

        function updateNavigationUI(stepIdx) {
            const step = navigationSteps[stepIdx] || navigationSteps[navigationSteps.length - 1];
            if (step) {
                document.getElementById('navMainText').innerText = step.main;
                document.getElementById('navSubText').innerText = step.sub;
                document.getElementById('navIcon').innerHTML = `<i class="fa ${step.icon}"></i>`;

                // Calculate remaining distance
                if (endPoint) {
                    const dist = map.distance(map.getCenter(), endPoint);
                    document.getElementById('navDistance').innerText = Math.round(dist) + " m";
                }
            }
        }

        function generateInstructions(path) {
            navigationSteps = [];
            // Simple generic instructions based on path turns
            // This is a simplified version. Real turn-by-turn needs bearing calculation.

            for (let i = 0; i < path.length - 1; i++) {
                const p1 = path[i];
                const p2 = path[i + 1];
                const bearing = calculateBearing(p1[0], p1[1], p2[0], p2[1]);

                let instruction = { main: "Lurus terus", sub: "Ikuti jalur", icon: "fa-arrow-up" };

                // Detect turns (simplified)
                if (i > 0) {
                    const p0 = path[i - 1];
                    const prevBearing = calculateBearing(p0[0], p0[1], p1[0], p1[1]);
                    const diff = (bearing - prevBearing + 360) % 360;

                    if (diff > 45 && diff < 135) {
                        instruction = { main: "Belok Kanan", sub: "Dalam 10m", icon: "fa-turn-right" };
                    } else if (diff > 225 && diff < 315) {
                        instruction = { main: "Belok Kiri", sub: "Dalam 10m", icon: "fa-turn-left" };
                    }
                }

                navigationSteps.push(instruction);
            }
            // Final step
            navigationSteps.push({ main: "Tiba di tujuan", sub: "Lokasi di sebelah Anda", icon: "fa-check-circle" });
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) -
                Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
            const brng = Math.atan2(y, x) * 180 / Math.PI;
            return (brng + 360) % 360;
        }

        function calculateRoute() {
            if (!startPoint || !endPoint) {
                alert("Harap pilih titik awal dan tujuan.");
                return;
            }
            if (typeof routingGraph === 'undefined') {
                alert("Data routing graph belum siap.");
                return;
            }

            const btn = document.getElementById('routeBtn');
            btn.innerText = "Menghitung...";
            btn.disabled = true;

            setTimeout(() => {
                const startNode = findNearestNode(startPoint.lat, startPoint.lng);
                const endNode = findNearestNode(endPoint.lat, endPoint.lng);

                if (startNode) {
                    const sc = routingGraph.nodes[startNode];
                    const d = Math.sqrt((startPoint.lat - sc[0]) ** 2 + (startPoint.lng - sc[1]) ** 2) * 111000;
                    if (d > 200) {
                        if (!confirm("Titik awal agak jauh (>200m) dari jalur terdata. Lanjutkan?")) {
                            btn.innerText = "Cari Rute"; btn.disabled = false;
                            return;
                        }
                    }
                }

                if (!startNode || !endNode) {
                    alert("Gagal menemukan titik jalur terdekat.");
                    btn.innerText = "Cari Rute"; btn.disabled = false;
                    return;
                }

                const path = dijkstra(startNode, endNode);
                if (path) {
                    currentPath = path;
                    if (routeLayer) map.removeLayer(routeLayer);
                    routeLayer = L.polyline(path, {
                        color: '#1a73e8',
                        weight: 6,
                        opacity: 0.8,
                        dashArray: '10, 10',
                        lineCap: 'round'
                    }).addTo(map);
                    map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });

                    let totalDist = 0;
                    for (let i = 0; i < path.length - 1; i++) {
                        totalDist += map.distance(path[i], path[i + 1]);
                    }
                    const timeMins = Math.round(totalDist / 80);

                    document.getElementById('routeInfo').innerHTML =
                        `<strong>${Math.round(totalDist)} m</strong> &middot; ~${timeMins} menit jalan kaki`;
                    document.getElementById('startNavBtn').style.display = '';

                    btn.innerText = "Cari Rute"; btn.disabled = false;
                } else {
                    alert("Tidak ada jalur yang terhubung.");
                    btn.innerText = "Cari Rute"; btn.disabled = false;
                }
            }, 50);
        }

        // ========== EXTRA LAYERS ==========
        function renderExtraLayers() {
            if (typeof masjidilHaramRoads !== 'undefined' && masjidilHaramRoads.length > 0) {
                masjidilHaramRoads.forEach(road => {
                    const polyline = L.polyline(road.geometry.coordinates, {
                        color: '#a8a29e', weight: 2, opacity: 0.6
                    });
                    const name = road.properties.name || road.properties.highway_type || 'Road';
                    const nameAr = road.properties.name_ar || name;
                    polyline.bindPopup(`<b>${nameAr}</b><br>${name}`);
                    roadsLayer.addLayer(polyline);
                });
                roadsLayer.addTo(map);
            }

            if (typeof masjidilHaramBuildings !== 'undefined' && masjidilHaramBuildings.length > 0) {
                masjidilHaramBuildings.forEach(building => {
                    const polygon = L.polygon(building.geometry.coordinates, {
                        color: '#c2410c', weight: 1, fillColor: '#fdba74', fillOpacity: 0.2
                    });
                    const name = building.properties.name || building.properties.building_type || 'Building';
                    const nameAr = building.properties.name_ar || name;
                    polygon.bindPopup(`<b>${nameAr}</b><br>${name}`);
                    buildingsLayer.addLayer(polygon);
                });
            }
        }

        // ========== SHARE ==========
        function shareLocation(name, lat, lng) {
            const mapsUrl = lat && lng ? `https://www.google.com/maps?q=${lat},${lng}` : '';
            const shareText = mapsUrl ? `${name}\n${mapsUrl}` : name;

            if (navigator.share) {
                const shareData = { title: name, text: `Lokasi: ${name}` };
                if (mapsUrl) shareData.url = mapsUrl;
                navigator.share(shareData);
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Link lokasi telah disalin!');
                }).catch(() => {
                    prompt('Salin link lokasi:', shareText);
                });
            } else {
                prompt('Salin link lokasi:', shareText);
            }
        }

        // ========== LOAD DATA ==========
        document.addEventListener('DOMContentLoaded', () => {
            masjidilHaramLocations.forEach(location => {
                const marker = createPinholeMarker(location);
                const type = location.properties.type;
                const clusterTypes = ['Support', 'Hotel', 'Landmark', 'Transportation', 'Food', 'Holy Site', 'Mosque', 'W C'];
                if (clusterTypes.includes(type)) {
                    clusterGroup.addLayer(marker);
                } else {
                    markersLayer.addLayer(marker);
                }
            });

            renderLocationsList();
            renderExtraLayers();
            updateCategoryChips(masjidilHaramLocations, ''); // Initial chip render

            // ========== CHIPS SCROLL EFFECT ==========
            const categoryChipsEl = document.getElementById('categoryChips');
            const chipsWrapperEl = document.getElementById('chipsWrapper');

            function checkScroll() {
                if (!categoryChipsEl || !chipsWrapperEl) return;

                // Check if scrolled from start
                if (categoryChipsEl.scrollLeft > 10) {
                    chipsWrapperEl.classList.add('can-scroll-left');
                } else {
                    chipsWrapperEl.classList.remove('can-scroll-left');
                }

                // Check if can scroll further right
                // Use a small tolerance (2px)
                if (categoryChipsEl.scrollLeft < (categoryChipsEl.scrollWidth - categoryChipsEl.clientWidth - 2)) {
                    chipsWrapperEl.classList.add('can-scroll-right');
                } else {
                    chipsWrapperEl.classList.remove('can-scroll-right');
                }
            }

            if (categoryChipsEl) {
                categoryChipsEl.addEventListener('scroll', checkScroll);
                setTimeout(checkScroll, 100);
                setTimeout(checkScroll, 500);
                window.addEventListener('resize', checkScroll);
            }

            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(() => { });
            }
        });
    </script>

    <footer
        style="text-align: center; padding: 1.5rem; color: #5f6368; font-size: 0.85rem; background: #fafafa; border-top: 1px solid #e0e0e0; position: relative; z-index: 10;">
        <p>¬© Copyright Sahabat Al-Fatihah</p>
    </footer>
</body>

</html>