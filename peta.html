<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Peta Premium Masjidil Haram - AL HARAMAIN</title>

    <!-- Leaflet & GIS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- Fonts & Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Amiri:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            background: #f5f5f5;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        /* ========== SEARCH HEADER ========== */
        .map-header {
            position: absolute;
            top: 12px;
            left: 12px;
            right: 12px;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: visible;
        }

        .search-box {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 12px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: #f1f3f4;
            border-radius: 8px;
            padding: 10px 14px;
            gap: 10px;
        }

        .search-input-wrapper input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font-size: 16px;
            color: #202124;
        }

        .search-input-wrapper i {
            color: #5f6368;
        }

        /* Category chips - below search on mobile */
        .category-chips {
            display: flex;
            gap: 8px;
            padding: 8px 12px 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .category-chips::-webkit-scrollbar {
            display: none;
        }

        .chip {
            padding: 8px 14px;
            border-radius: 20px;
            background: white;
            border: 1px solid #dadce0;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chip:hover,
        .chip.active {
            background: #e8f0fe;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        .chip i {
            margin-right: 6px;
        }

        /* ========== APPLE MAPS STYLE MARKERS ========== */
        .pinhole-marker {
            background: none !important;
            border: none !important;
            cursor: pointer;
        }

        .pinhole-marker .marker-wrapper {
            position: relative;
            width: 0;
            height: 0;
        }

        /* --- DEFAULT: small circle, label on hover only --- */
        .pinhole-marker .marker-default {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 4px;
            left: 0;
            top: 0;
            transform: translate(-16px, -16px);
        }

        .marker-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #1a73e8;
            border: 2.5px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .marker-circle i {
            color: white;
            font-size: 13px;
        }

        .marker-default-label {
            background: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #202124;
            white-space: nowrap;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
            max-width: 110px;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        /* Show label only on hover */
        .pinhole-marker:hover .marker-default-label {
            opacity: 1;
        }

        .pinhole-marker:hover .marker-circle {
            transform: scale(1.15);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.4);
        }

        /* --- ACTIVE: large balloon pin + dot + label below --- */
        .pinhole-marker .marker-active {
            position: absolute;
            left: 0;
            top: 0;
            transform: translate(-32px, -90px);
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .marker-balloon {
            width: 56px;
            height: 56px;
            border-radius: 50% 50% 50% 0;
            background: #1a73e8;
            transform: rotate(-45deg);
            border: 4px solid white;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .marker-balloon i {
            transform: rotate(45deg);
            color: white;
            font-size: 22px;
        }

        .marker-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #1a73e8;
            border: 2px solid white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
            margin-top: 4px;
        }

        .marker-active-label {
            margin-top: 4px;
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #202124;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Toggle between default and active */
        .pinhole-marker.active .marker-default {
            display: none;
        }

        .pinhole-marker.active .marker-active {
            display: flex;
            animation: pinPop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pinPop {
            0% {
                transform: translate(-32px, -90px) scale(0.4);
                opacity: 0;
            }

            60% {
                transform: translate(-32px, -90px) scale(1.08);
                opacity: 1;
            }

            100% {
                transform: translate(-32px, -90px) scale(1);
            }
        }

        /* ========== FLOATING BUTTONS (mobile: bottom-left stacked, desktop: below search) ========== */
        .floating-btns {
            position: absolute;
            bottom: 24px;
            left: 12px;
            z-index: 1002;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .fab-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            color: #202124;
        }

        .fab-btn:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
            transform: scale(1.05);
        }

        .fab-btn.kaaba {
            color: #d4af37;
            font-size: 20px;
        }

        .fab-btn.hidden {
            display: none;
        }

        /* ========== BOTTOM SHEET ========== */
        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 70vh;
            display: flex;
            flex-direction: column;
        }

        .bottom-sheet.expanded {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 36px;
            height: 4px;
            background: #dadce0;
            border-radius: 2px;
            margin: 8px auto;
            cursor: grab;
        }

        .sheet-peek {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .peek-title {
            font-size: 18px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 4px;
        }

        .peek-subtitle {
            font-size: 14px;
            color: #5f6368;
        }

        .sheet-close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f1f3f4;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #5f6368;
            font-size: 14px;
            flex-shrink: 0;
        }

        .sheet-close-btn:hover {
            background: #e8eaed;
        }

        .sheet-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .location-detail {
            display: none;
        }

        .location-detail.active {
            display: block;
        }

        .detail-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
        }

        .detail-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .detail-info h2 {
            font-size: 24px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 4px;
        }

        .detail-info .arabic {
            font-family: 'Amiri', serif;
            font-size: 20px;
            color: #d4af37;
            display: block;
            margin-top: 4px;
        }

        .detail-info p {
            font-size: 14px;
            color: #5f6368;
            margin-top: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin: 20px 0;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background: #1a73e8;
            color: white;
        }

        .action-btn.primary:hover {
            background: #1557b0;
        }

        .action-btn.secondary {
            background: #f1f3f4;
            color: #202124;
        }

        .action-btn.secondary:hover {
            background: #e8eaed;
        }

        /* Locations List */
        .locations-list {
            padding: 0;
        }

        .list-category {
            margin-bottom: 24px;
        }

        .category-header {
            font-size: 12px;
            font-weight: 500;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .location-item:hover {
            background: #e8f0fe;
        }

        .item-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }

        .item-info h3 {
            font-size: 15px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 2px;
        }

        .item-info .arabic {
            font-family: 'Amiri', serif;
            font-size: 13px;
            color: #5f6368;
        }

        /* Holy Site Pills */
        .holy-site-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .holy-site-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 20px;
            background: #fef9e7;
            border: 1.5px solid #d4af37;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
            color: #7c6a1e;
        }

        .holy-site-pill:hover {
            background: #d4af37;
            color: white;
        }

        .holy-site-pill i {
            font-size: 12px;
            color: #d4af37;
        }

        .holy-site-pill:hover i {
            color: white;
        }

        /* Accordion sections */
        .category-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            text-align: left;
        }

        .category-toggle .toggle-icon {
            font-size: 11px;
            color: #5f6368;
            transition: transform 0.2s;
        }

        .category-toggle.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .category-items {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-items.collapsed {
            max-height: 0 !important;
        }

        /* Pulsating dot for user location */
        .user-location-marker {
            background: none !important;
            border: none !important;
        }

        .pulse-dot {
            width: 14px;
            height: 14px;
            background: #1a73e8;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 rgba(26, 115, 232, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(26, 115, 232, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(26, 115, 232, 0);
            }
        }

        /* Search dropdown */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            max-height: 320px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 0 0 12px 12px;
            z-index: 1001;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            transition: background 0.15s;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: #f1f3f4;
        }

        .search-result-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            flex-shrink: 0;
        }

        .search-result-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-info .name {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-info .type {
            font-size: 12px;
            color: #5f6368;
        }

        /* Cluster Styles */
        .marker-cluster-small,
        .marker-cluster-medium,
        .marker-cluster-large {
            background-color: rgba(26, 115, 232, 0.3) !important;
        }

        .marker-cluster div {
            background-color: #1a73e8 !important;
            color: white !important;
            border: 3px solid white;
            font-weight: 700;
            border-radius: 50%;
        }

        /* Hide default leaflet popup */
        .leaflet-popup {
            display: none !important;
        }

        /* ========== DIRECTIONS BOX (GOOGLE MAPS STYLE) ========== */
        .directions-box {
            display: none;
            padding: 16px;
            background: white;
            flex-direction: column;
            gap: 12px;
            border-bottom: 1px solid #f1f3f4;
        }

        .directions-box.active {
            display: flex;
        }

        .dir-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dir-dots {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .dot-start {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 2px solid #1a73e8;
        }

        .dot-line {
            width: 2px;
            height: 20px;
            background: #dadce0;
        }

        .dot-end {
            width: 8px;
            height: 8px;
            background: #1a73e8;
        }

        .dir-inputs {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dir-input-wrapper {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dir-input-wrapper input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font-size: 14px;
            color: #202124;
        }

        .dir-input-wrapper .pick-btn {
            background: none;
            border: none;
            color: #5f6368;
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
        }

        .dir-input-wrapper .pick-btn:hover {
            color: #1a73e8;
        }

        .dir-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }

        .nav-btn-start {
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 24px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .nav-btn-start:disabled {
            background: #dadce0;
            color: #5f6368;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* ========== NAVIGATION OVERLAY (APPLE MAPS STYLE) ========== */
        .nav-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: #202124;
            color: white;
            border-radius: 16px;
            padding: 16px;
            display: none;
            align-items: center;
            gap: 16px;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .nav-overlay.active {
            display: flex;
        }

        .nav-icon-large {
            font-size: 32px;
            color: #1a73e8;
        }

        .nav-text {
            flex: 1;
        }

        .nav-instruction {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .nav-sub-instruction {
            font-size: 14px;
            color: #bdc1c6;
        }

        .nav-close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* ========== LANDMARK MODAL ========== */
        .landmark-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: flex-end;
        }

        .landmark-modal.active {
            display: flex;
        }

        .landmark-modal-content {
            background: white;
            width: 100%;
            max-width: 500px;
            max-height: 70vh;
            border-radius: 16px 16px 0 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .landmark-modal-header {
            padding: 16px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .landmark-modal-header h3 {
            font-size: 18px;
            font-weight: 500;
            color: #202124;
        }

        .landmark-search {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f3f4;
        }

        .landmark-search input {
            width: 100%;
            padding: 10px 14px;
            background: #f1f3f4;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .landmark-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .landmark-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .landmark-item:hover {
            background: #f1f3f4;
        }

        .landmark-item i {
            color: #d4af37;
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        .landmark-item-info {
            flex: 1;
        }

        .landmark-item-info .name {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
        }

        .landmark-item-info .arabic {
            font-family: 'Amiri', serif;
            font-size: 13px;
            color: #5f6368;
        }

        /* ========== DESKTOP (>= 768px) ========== */
        @media (min-width: 768px) {
            .map-header {
                right: auto;
                width: 392px;
                border-radius: 8px;
            }

            /* Chips inside header on desktop */
            .category-chips {
                padding: 0 12px 10px;
            }

            /* Floating buttons below searchbox on desktop */
            .floating-btns {
                top: 72px;
                left: 12px;
                bottom: auto;
                flex-direction: row;
                gap: 8px;
            }

            /* Bottom sheet as side panel on desktop */
            .bottom-sheet {
                top: 72px;
                left: 420px;
                bottom: auto;
                right: auto;
                width: 380px;
                max-height: calc(100vh - 100px);
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transform: translateX(-150%);
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .bottom-sheet.expanded {
                transform: translateX(0);
            }

            .nav-overlay {
                left: 420px;
                right: 20px;
                top: 20px;
                max-width: 450px;
            }

            .landmark-modal {
                align-items: center;
            }

            .landmark-modal-content {
                border-radius: 16px;
            }
        }

        /* --- PREMIUM LOCK SCREEN --- */
        #site-lock {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #site-lock.unlocked {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-100%);
        }

        .lock-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            padding: 2.5rem;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .lock-card h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .lock-card p {
            font-weight: 300;
            margin-bottom: 2rem;
            opacity: 0.8;
        }

        .lock-input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .lock-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 1.2rem;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            text-align: center;
            outline: none;
            transition: all 0.3s ease;
        }

        .lock-input:focus {
            border-color: #d4af37;
            background: rgba(255, 255, 255, 0.25);
        }

        .lock-btn {
            background: #d4af37;
            color: #064e3b;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .lock-btn:hover {
            background: #f1c40f;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .lock-error {
            color: #ff9999;
            font-size: 0.9rem;
            margin-top: 1rem;
            height: 1.2rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .lock-error.show {
            opacity: 1;
        }
    </style>
</head>

<body>
    <!-- Premium Lock Screen -->
    <div id="site-lock">
        <div class="lock-card">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üóùÔ∏è</div>
            <h2>Kunci Ibadah</h2>
            <p>Silakan masukkan kunci untuk membuka panduan Al Haramain.</p>
            <div class="lock-input-group">
                <input type="text" id="site-key" class="lock-input" placeholder="Masukkan kunci..." autocomplete="off">
                <div id="lock-error" class="lock-error">Kunci salah, silakan coba lagi.</div>
            </div>
            <button onclick="checkKey()" class="lock-btn">Buka Panduan</button>
        </div>
    </div>

    <script>
        function checkKey() {
            const input = document.getElementById('site-key').value.trim().toLowerCase();
            const lock = document.getElementById('site-lock');
            const error = document.getElementById('lock-error');

            if (input === 'al-fatihah') {
                lock.classList.add('unlocked');
                sessionStorage.setItem('site_unlocked', 'true');
            } else {
                error.classList.add('show');
                document.getElementById('site-key').value = '';
                setTimeout(() => error.classList.remove('show'), 3000);
            }
        }

        // Handle Enter key
        document.getElementById('site-key')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkKey();
        });

        // Check if already unlocked
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('site_unlocked') === 'true') {
                document.getElementById('site-lock').style.display = 'none';
            }
        });
    </script>

    <!-- Google Maps Style Header -->
    <div class="map-header" id="mapHeader" style="position:relative;">
        <div class="search-box" id="searchBox">
            <button class="back-btn" onclick="window.location.href='index.html'">
                <i class="fa fa-arrow-left"></i>
            </button>
            <div class="search-input-wrapper">
                <i class="fa fa-search"></i>
                <input type="text" id="searchInput" placeholder="Cari lokasi, gerbang, fasilitas..."
                    oninput="filterLocations()">
            </div>
            <button class="back-btn" style="box-shadow: none;" id="directionsToggleBtn" onclick="toggleDirections()">
                <i class="fa fa-directions"></i>
            </button>
        </div>
        <div class="search-results" id="searchResults"></div>

        <!-- Directions Search Box -->
        <div class="directions-box" id="directionsBox">
            <div class="dir-input-group">
                <div class="dir-dots">
                    <div class="dot-start"></div>
                    <div class="dot-line"></div>
                    <div class="dot-end"></div>
                </div>
                <div class="dir-inputs">
                    <div class="dir-input-wrapper">
                        <input type="text" id="startInput" placeholder="Pilih titik awal..." readonly>
                        <button class="pick-btn" onclick="openLandmarkModal('start')" title="Pilih Landmark"><i
                                class="fa fa-university"></i></button>
                        <button class="pick-btn" onclick="setPickMode('start')" title="Pilih di Peta"><i
                                class="fa fa-map-pin"></i></button>
                    </div>
                    <div class="dir-input-wrapper">
                        <input type="text" id="endInput" placeholder="Pilih tujuan..." readonly>
                        <button class="pick-btn" onclick="openLandmarkModal('end')" title="Pilih Landmark"><i
                                class="fa fa-university"></i></button>
                        <button class="pick-btn" onclick="setPickMode('end')" title="Pilih di Peta"><i
                                class="fa fa-map-pin"></i></button>
                    </div>
                </div>
            </div>
            <div class="dir-actions">
                <span id="routeInfo" style="font-size: 13px; color: #5f6368;">Pilih lokasi di peta atau dari
                    daftar</span>
                <div style="display: flex; gap: 8px;">
                    <button class="nav-btn-start" id="routeBtn" onclick="calculateRoute()">Cari Rute</button>
                    <button class="nav-btn-start" id="startNavBtn" style="display: none; background: #34a853;"
                        onclick="startNavigation()">Mulai</button>
                </div>
            </div>
        </div>

        <div class="category-chips" id="categoryChips">
            <div class="chip active" data-category="all"><i class="fa fa-globe"></i> Semua</div>
            <div class="chip" data-category="Holy Site"><i class="fa fa-kaaba"></i> Holy Site</div>
            <div class="chip" data-category="Mosque"><i class="fa fa-mosque"></i> Masjid</div>
            <div class="chip" data-category="Gate"><i class="fa fa-door-open"></i> Gerbang</div>
            <div class="chip" data-category="Hotel"><i class="fa fa-hotel"></i> Hotel</div>
            <div class="chip" data-category="W C"><i class="fa fa-restroom"></i> WC</div>
            <div class="chip" data-category="Medical"><i class="fa fa-hospital"></i> Medis</div>
            <div class="chip" data-category="Food"><i class="fa fa-utensils"></i> Makanan</div>
            <div class="chip" data-category="Zamzam/Water"><i class="fa fa-tint"></i> Zamzam</div>
            <div class="chip" data-category="Transportation"><i class="fa fa-bus"></i> Transportasi</div>
            <div class="chip" data-category="Landmark"><i class="fa fa-map-marker-alt"></i> Landmark</div>
        </div>
    </div>

    <!-- Apple Maps Style Navigation Overlay -->
    <div class="nav-overlay" id="navOverlay">
        <div class="nav-icon-large" id="navIcon">
            <i class="fa fa-arrow-up"></i>
        </div>
        <div class="nav-text">
            <div class="nav-instruction" id="navMainText">Lurus terus</div>
            <div class="nav-sub-instruction" id="navSubText">Tetap di jalur</div>
        </div>
        <div style="text-align: right; margin-right: 10px;">
            <div id="navDistance" style="font-size: 20px; font-weight: bold; color: #1a73e8;">0 m</div>
        </div>
        <button class="nav-close-btn" onclick="stopNavigation()">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- Floating Buttons -->
    <div class="floating-btns" id="floatingBtns">
        <button class="fab-btn" id="sheetToggleBtn" onclick="toggleBottomSheet()" title="Daftar Lokasi">
            <i class="fa fa-bars"></i>
        </button>
        <button class="fab-btn kaaba" id="centerHaramBtn" onclick="goToHaramCenter()" title="Ke Ka'bah">
            <i class="fa fa-kaaba"></i>
        </button>
    </div>

    <!-- Bottom Sheet -->
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-handle" id="sheetHandle"></div>
        <div class="sheet-peek" id="sheetPeek">
            <div>
                <div class="peek-title">Masjidil Haram</div>
                <div class="peek-subtitle">Daftar lokasi penting</div>
            </div>
            <button class="sheet-close-btn" onclick="closeBottomSheet()" title="Tutup">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="sheet-content" id="sheetContent">
            <div id="locationDetail" class="location-detail"></div>
            <div id="locationsList" class="locations-list"></div>
        </div>
    </div>

    <!-- Landmark Modal -->
    <div class="landmark-modal" id="landmarkModal">
        <div class="landmark-modal-content">
            <div class="landmark-modal-header">
                <h3>Pilih Landmark</h3>
                <button onclick="closeLandmarkModal()"
                    style="background:none; border:none; font-size:20px; cursor:pointer; color:#5f6368;">&times;</button>
            </div>
            <div class="landmark-search">
                <input type="text" id="landmarkSearch" placeholder="Cari landmark..." onkeyup="filterLandmarks()">
            </div>
            <div class="landmark-list" id="landmarkList"></div>
        </div>
    </div>

    <div id="map"></div>

    <!-- Data & Scripts -->
    <script src="masjidil-haram-data.js"></script>
    <script src="osm_data/haram-routing-graph-v2.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // ========== STATE ==========
        let startPoint = null;
        let endPoint = null;
        let startMarker = null;
        let endMarker = null;
        let routeLayer = null;
        let pickingMode = null;
        let navigationActive = false;
        let currentPath = [];
        let navigationSteps = [];
        let landmarkPickingType = 'start';
        let activeMarker = null;
        let allMarkers = [];
        let activeCategory = 'all';

        // ========== MAP INIT ==========
        const map = L.map('map', {
            zoomControl: false,
            center: [21.4245, 39.8227],
            zoom: 17,
            maxZoom: 19,
            minZoom: 13
        });

        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Base Layers
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 19
        });

        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        });

        const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
            zIndex: 1000,
            maxZoom: 20
        });

        satellite.addTo(map);

        const baseMaps = { "Satelit": satellite, "Peta Biasa (OSM)": osmLayer };
        const overlayMaps = { "Label": labels };
        window.layerControl = L.control.layers(baseMaps, overlayMaps, { position: 'topright' }).addTo(map);

        // Color mapping
        const markerColors = {
            'Holy Site': '#d4af37',
            'Mosque': '#2e7d32',
            'Main Gate': '#064e3b',
            'Gate': '#3498db',
            'Hotel': '#8e44ad',
            'Medical': '#e67e22',
            'W C': '#06b6d4',
            'Food': '#10b981',
            'Zamzam/Water': '#3b82f6',
            'Elevator': '#8b5cf6',
            'Escalator': '#ec4899',
            'Stairs': '#f97316',
            'Transportation': '#6366f1',
            'Amenities': '#f59e0b',
            'Support': '#475569',
            'Landmark': '#e74c3c'
        };

        const markersLayer = L.layerGroup().addTo(map);
        const clusterGroup = L.markerClusterGroup({
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            spiderfyOnMaxZoom: true,
            maxClusterRadius: 50
        }).addTo(map);

        // Extra layers (Roads & Buildings)
        const roadsLayer = L.featureGroup();
        const buildingsLayer = L.featureGroup();

        if (window.layerControl) {
            window.layerControl.addOverlay(markersLayer, "Points of Interest");
            window.layerControl.addOverlay(clusterGroup, "Facilities (Clustered)");
            window.layerControl.addOverlay(roadsLayer, "Roads / Jalur");
            window.layerControl.addOverlay(buildingsLayer, "Buildings / Bangunan");
        }

        // ========== GPS ==========
        L.Control.Gps = L.Control.extend({
            onAdd: function (map) {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                div.innerHTML = '<a href="#" title="Lokasi Saya" style="font-size: 18px; display: flex; align-items: center; justify-content: center; width: 34px; height: 34px;"><i class="fa fa-crosshairs"></i></a>';
                div.style.cursor = 'pointer';
                div.onclick = function (e) {
                    e.preventDefault();
                    map.locate({ setView: true, maxZoom: 18 });
                };
                return div;
            }
        });
        new L.Control.Gps({ position: 'bottomright' }).addTo(map);

        map.locate({ setView: true, maxZoom: 18 });

        map.on('locationfound', function (e) {
            if (navigationActive) {
                let minDiv = Infinity;
                let nearestIdx = 0;
                currentPath.forEach((p, idx) => {
                    const d = map.distance(e.latlng, p);
                    if (d < minDiv) { minDiv = d; nearestIdx = idx; }
                });
                updateNavigationUI(nearestIdx);
                // Also update user pulse marker if exists
                if (window.userPulseMarker) window.userPulseMarker.setLatLng(e.latlng);
                else {
                    const pulseIcon = L.divIcon({
                        className: 'user-location-marker',
                        html: '<div class="pulse-dot"></div>',
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    });
                    window.userPulseMarker = L.marker(e.latlng, { icon: pulseIcon }).addTo(map);
                }
                return;
            }
            const radius = e.accuracy / 2;

            if (window.userPulseMarker) window.userPulseMarker.setLatLng(e.latlng);
            else {
                const pulseIcon = L.divIcon({
                    className: 'user-location-marker',
                    html: '<div class="pulse-dot"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
                window.userPulseMarker = L.marker(e.latlng, { icon: pulseIcon }).addTo(map);
            }

            if (window.userAccuracyCircle) window.userAccuracyCircle.setLatLng(e.latlng).setRadius(radius);
            else window.userAccuracyCircle = L.circle(e.latlng, radius, { color: '#1a73e8', weight: 1, fillOpacity: 0.1 }).addTo(map);
        });

        // ========== PINHOLE MARKERS ==========
        function createPinholeMarker(feature) {
            let type = feature.properties.type;
            let color = markerColors[type] || '#1a73e8';
            const categoryClass = type.toLowerCase().replace(/ /g, '-');
            let iconClass = feature.properties.icon || 'fa-map-marker';
            const name = feature.properties.name_en || feature.properties.name;

            // --- CUSTOM: 5 MAIN GATES ---
            const mainGateOsmIds = [
                '4755914231', // King Abdul Aziz Gate 1
                '3210622327', // King Fahd Gate 79
                '5875587679', // King Abdullah Gate 100
                '6301219294', // Bab Al-Salam (Gate 24)
                '4318154228'  // Umra Gate 40 (or 62)
            ];

            if (mainGateOsmIds.includes(String(feature.properties.osm_id))) {
                iconClass = 'fa-archway'; // Distinct icon for main gates
                // Force "Main Gate" color #064e3b (Dark Green) 
                // or Gold #d4af37 if preferred. Let's use Dark Green for official "Main Gate" feel
                // or revert to user request "distinct from normal gate (blue)".
                // Normal "Gate" is Blue. "Main Gate" key is Dark Green.
                color = markerColors['Main Gate'];
            }

            const icon = L.divIcon({
                className: 'pinhole-marker',
                html: `
                    <div class="marker-wrapper">
                        <div class="marker-default">
                            <div class="marker-circle" style="background: ${color};">
                                <i class="fa ${iconClass}"></i>
                            </div>
                            <div class="marker-default-label">${name}</div>
                        </div>
                        <div class="marker-active">
                            <div class="marker-balloon" style="background: ${color};">
                                <i class="fa ${iconClass}"></i>
                            </div>
                            <div class="marker-dot" style="background: ${color};"></div>
                            <div class="marker-active-label">${name}</div>
                        </div>
                    </div>
                `,
                iconSize: [0, 0],
                iconAnchor: [0, 0]
            });

            const coords = feature.geometry.coordinates;
            const marker = L.marker([coords[1], coords[0]], { icon: icon });

            marker.on('click', function () {
                showLocationDetail(feature, marker);
                if (activeMarker && activeMarker !== marker) {
                    const el = activeMarker.getElement();
                    if (el) el.classList.remove('active');
                }
                const el = marker.getElement();
                if (el) el.classList.add('active');
                activeMarker = marker;
                map.flyTo([coords[1], coords[0]], 18);
            });

            allMarkers.push({ marker, feature });
            return marker;
        }

        // ========== BOTTOM SHEET ==========
        function showLocationDetail(feature, marker) {
            // Deactivate previous active marker
            if (activeMarker) {
                const el = activeMarker.getElement();
                if (el) el.classList.remove('active');
            }

            // Activate new marker
            activeMarker = marker;
            const el = marker.getElement();
            if (el) el.classList.add('active');

            const props = feature.properties;
            const type = props.type;
            const color = markerColors[type] || '#1a73e8';
            const coords = feature.geometry.coordinates;

            const detailHTML = `
                <button onclick="resetBottomSheet()" style="background:none; border:none; cursor:pointer; padding:4px 0; margin-bottom:12px; display:flex; align-items:center; gap:6px; color:#1a73e8; font-size:14px; font-weight:500;">
                    <i class="fa fa-chevron-left" style="font-size:12px;"></i> Kembali ke daftar
                </button>
                <div class="detail-header">
                    <div class="detail-icon" style="background: ${color};">
                        <i class="fa ${props.icon || 'fa-map-marker-alt'}"></i>
                    </div>
                    <div class="detail-info">
                        <h2>${props.name_en || props.name}</h2>
                        <span class="arabic">${props.name}</span>
                        <p>${type} &middot; Lantai ${props.floor || 'Dasar'}</p>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="routeToLocation([${coords[1]}, ${coords[0]}], '${(props.name_en || props.name).replace(/'/g, "\\'")}')">
                        <i class="fa fa-directions"></i> Rute
                    </button>
                    <button class="action-btn secondary" onclick="shareLocation('${(props.name_en || props.name).replace(/'/g, "\\'")}')">
                        <i class="fa fa-share"></i> Bagikan
                    </button>
                </div>
            `;

            const detailEl = document.getElementById('locationDetail');
            if (detailEl) {
                detailEl.innerHTML = detailHTML;
                detailEl.classList.add('active');
                const listEl = document.getElementById('locationsList');
                if (listEl) listEl.style.display = 'none';
                openBottomSheet();
            }
        }


        function resetBottomSheet() {
            document.getElementById('locationDetail').classList.remove('active');
            document.getElementById('locationDetail').innerHTML = '';
            document.getElementById('locationsList').style.display = '';
            if (activeMarker) {
                const el = activeMarker.getElement();
                if (el) el.classList.remove('active');
                activeMarker = null;
            }
        }

        // ========== LOCATIONS LIST ==========
        const categoryLabels = {
            'Holy Site': 'Holy Site', 'Mosque': 'Masjid', 'Main Gate': 'Pintu Utama',
            'Gate': 'Gerbang', 'W C': 'WC', 'Zamzam/Water': 'Zamzam',
            'Medical': 'Medis', 'Transportation': 'Transportasi', 'Hotel': 'Hotel',
            'Food': 'Makanan', 'Amenities': 'Fasilitas', 'Escalator': 'Eskalator',
            'Elevator': 'Lift', 'Stairs': 'Tangga', 'Support': 'Support', 'Landmark': 'Landmark'
        };
        const categoryIcons = {
            'Holy Site': 'fa-kaaba', 'Mosque': 'fa-mosque', 'Main Gate': 'fa-archway',
            'Gate': 'fa-door-open', 'W C': 'fa-restroom', 'Zamzam/Water': 'fa-tint',
            'Medical': 'fa-hospital', 'Transportation': 'fa-bus', 'Hotel': 'fa-hotel',
            'Food': 'fa-utensils', 'Amenities': 'fa-cogs', 'Escalator': 'fa-arrows-alt-v',
            'Elevator': 'fa-arrows-alt-v', 'Stairs': 'fa-shoe-prints', 'Support': 'fa-life-ring', 'Landmark': 'fa-map-marker-alt'
        };

        function renderLocationsList(data) {
            data = data || masjidilHaramLocations;
            const grouped = {};
            data.forEach(item => {
                const t = item.properties.type;
                if (!grouped[t]) grouped[t] = [];
                grouped[t].push(item);
            });

            const typeOrder = [
                'Holy Site', 'Mosque', 'Main Gate', 'Gate',
                'W C', 'Zamzam/Water', 'Medical', 'Transportation',
                'Hotel', 'Food', 'Amenities',
                'Escalator', 'Elevator', 'Stairs',
                'Support', 'Landmark'
            ];

            let html = '';
            typeOrder.forEach(type => {
                if (!grouped[type]) return;
                const color = markerColors[type] || '#475569';
                const label = categoryLabels[type] || type;
                const catIcon = categoryIcons[type] || 'fa-folder';
                const sectionId = type.replace(/[\/ ]/g, '-');

                // Header with accordion toggle
                html += `<div class="list-category">
                    <button class="category-toggle" onclick="toggleSection('${sectionId}', this)">
                        <div class="category-header" style="margin-bottom:0;">
                            <i class="fa ${catIcon}" style="color:${color};"></i> ${label} (${grouped[type].length})
                        </div>
                        <i class="fa fa-chevron-down toggle-icon"></i>
                    </button>`;

                // Holy Site rendered as pills
                if (type === 'Holy Site') {
                    html += `<div class="category-items" id="section-${sectionId}">
                        <div class="holy-site-pills" style="margin-top:10px;">`;
                    grouped[type].forEach(item => {
                        html += `<div class="holy-site-pill" onclick="selectLocation('${item.properties.osm_id}')">
                            <i class="fa ${item.properties.icon || 'fa-kaaba'}"></i>
                            ${item.properties.name_en || item.properties.name}
                        </div>`;
                    });
                    html += `</div></div></div>`;
                    return;
                }

                // Regular items
                html += `<div class="category-items" id="section-${sectionId}">`;
                grouped[type].forEach(item => {
                    html += `
                        <div class="location-item" onclick="selectLocation('${item.properties.osm_id}')">
                            <div class="item-icon" style="background: ${color};">
                                <i class="fa ${item.properties.icon}"></i>
                            </div>
                            <div class="item-info">
                                <h3>${item.properties.name_en || item.properties.name}</h3>
                                <div class="arabic">${item.properties.name}</div>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            });

            document.getElementById('locationsList').innerHTML = html;
        }

        function toggleSection(sectionId, btnEl) {
            const items = document.getElementById('section-' + sectionId);
            if (!items) return;
            items.classList.toggle('collapsed');
            btnEl.classList.toggle('collapsed');
        }

        function goToHaramCenter() {
            map.flyTo([21.4225, 39.8262], 18);
        }

        function selectLocation(osmId) {
            // Close search results if open
            const searchResults = document.querySelector('.search-results');
            if (searchResults) searchResults.style.display = 'none';

            const item = allMarkers.find(m => m.feature.properties.osm_id === osmId);
            if (item) item.marker.fire('click');
        }

        // ========== SEARCH & FILTER ==========
        function filterLocations() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const searchResults = document.getElementById('searchResults');
            let filtered = masjidilHaramLocations;

            // Apply category filter
            if (activeCategory !== 'all') {
                filtered = filtered.filter(loc => loc.properties.type === activeCategory);
            }

            // Apply search filter
            if (query) {
                filtered = filtered.filter(loc =>
                    (loc.properties.name || '').toLowerCase().includes(query) ||
                    (loc.properties.name_en || '').toLowerCase().includes(query) ||
                    (loc.properties.type || '').toLowerCase().includes(query)
                );
                // Show dropdown with results
                populateSearchResults(filtered.slice(0, 8));
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }

            // Always sync map markers and list
            renderLocationsList(filtered);
            filterMapMarkersByData(filtered);
        }

        function populateSearchResults(results) {
            const container = document.querySelector('.search-results');
            if (!container) return;

            if (results.length === 0) {
                container.innerHTML = '<div class="search-result-item" style="color:#5f6368; justify-content:center;">Tidak ditemukan</div>';
                return;
            }

            let html = '';
            results.forEach(item => {
                const props = item.properties;
                const type = props.type;
                const color = markerColors[type] || '#1a73e8';
                const icon = props.icon || 'fa-map-marker';

                html += `
                    <div class="search-result-item" onclick="selectLocation('${props.osm_id}')">
                        <div class="search-result-icon" style="background: ${color};">
                            <i class="fa ${icon}"></i>
                        </div>
                        <div class="search-result-info">
                            <div class="name">${props.name_en || props.name}</div>
                            <div class="type">${type}</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function filterMapMarkersByData(filteredData) {
            markersLayer.clearLayers();
            clusterGroup.clearLayers();

            const filteredOsmIds = new Set(filteredData.map(loc => loc.properties.osm_id));
            const clusterTypesList = ['Support', 'Hotel', 'Landmark', 'Transportation', 'Food', 'Holy Site', 'Mosque', 'W C'];

            allMarkers.forEach(({ marker, feature }) => {
                if (filteredOsmIds.has(feature.properties.osm_id)) {
                    const type = feature.properties.type;
                    if (clusterTypesList.includes(type)) {
                        clusterGroup.addLayer(marker);
                    } else {
                        markersLayer.addLayer(marker);
                    }
                }
            });
        }

        // Category chips
        document.querySelectorAll('.chip').forEach(chip => {
            chip.addEventListener('click', function () {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                activeCategory = this.dataset.category;
                filterLocations();
            });
        });

        // ========== BOTTOM SHEET TOGGLE ==========
        let startY = 0;
        const sheet = document.getElementById('bottomSheet');
        const handle = document.getElementById('sheetHandle');
        const peek = document.getElementById('sheetPeek');
        const toggleBtn = document.getElementById('sheetToggleBtn');

        function toggleBottomSheet() {
            if (sheet.classList.contains('expanded')) {
                closeBottomSheet();
            } else {
                openBottomSheet();
            }
        }

        function openBottomSheet() {
            sheet.classList.add('expanded');
            toggleBtn.style.display = 'none';
        }

        function closeBottomSheet() {
            sheet.classList.remove('expanded');
            toggleBtn.style.display = '';
            // Reset detail view if open
            document.getElementById('locationDetail').classList.remove('active');
            document.getElementById('locationDetail').innerHTML = '';
            document.getElementById('locationsList').style.display = '';
            if (activeMarker) {
                const el = activeMarker.getElement();
                if (el) el.classList.remove('active');
                activeMarker = null;
            }
        }

        // Drag to close on mobile
        function initSheetDrag(el) {
            el.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; });
            el.addEventListener('touchmove', (e) => {
                const diff = e.touches[0].clientY - startY;
                if (diff > 0) sheet.style.transform = `translateY(${diff}px)`;
            });
            el.addEventListener('touchend', (e) => {
                const rect = sheet.getBoundingClientRect();
                if (rect.top > window.innerHeight * 0.5) {
                    closeBottomSheet();
                } else {
                    sheet.classList.add('expanded');
                }
                sheet.style.transform = '';
            });
        }
        initSheetDrag(handle);

        // ========== DIRECTIONS TOGGLE ==========
        function toggleDirections() {
            const box = document.getElementById('directionsBox');
            const btn = document.getElementById('directionsToggleBtn');
            if (box.classList.contains('active')) {
                exitDirections();
            } else {
                box.classList.add('active');
                btn.innerHTML = '<i class="fa fa-times"></i>';
                document.getElementById('categoryChips').style.display = 'none';
            }
        }

        function exitDirections() {
            document.getElementById('directionsBox').classList.remove('active');
            document.getElementById('directionsToggleBtn').innerHTML = '<i class="fa fa-directions"></i>';
            document.getElementById('categoryChips').style.display = '';
            // Clean up route
            if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
            if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
            if (endMarker) { map.removeLayer(endMarker); endMarker = null; }
            startPoint = null; endPoint = null;
            document.getElementById('startInput').value = '';
            document.getElementById('endInput').value = '';
            document.getElementById('routeInfo').textContent = 'Pilih lokasi di peta atau dari daftar';
            document.getElementById('startNavBtn').style.display = 'none';
            currentPath = [];
        }

        // Route to location from detail view
        function routeToLocation(coords, name) {
            // Open directions box
            const box = document.getElementById('directionsBox');
            if (!box.classList.contains('active')) {
                box.classList.add('active');
                document.getElementById('directionsToggleBtn').innerHTML = '<i class="fa fa-times"></i>';
                document.getElementById('categoryChips').style.display = 'none';
            }
            // Set as destination
            const latlng = L.latLng(coords[1], coords[0]);
            setEndPoint(latlng, name);
            // Collapse bottom sheet
            sheet.classList.remove('expanded');
        }

        // ========== ROUTING POINTS ==========
        function setStartPoint(latlng, name) {
            if (startMarker) map.removeLayer(startMarker);
            startMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'pinhole-marker',
                    html: '<div style="background:#34a853;width:14px;height:14px;border-radius:50%;border:3px solid white;box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                })
            }).addTo(map);
            startPoint = latlng;
            document.getElementById('startInput').value = name;
            updateRouteInfo();
        }

        function setEndPoint(latlng, name) {
            if (endMarker) map.removeLayer(endMarker);
            endMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'pinhole-marker',
                    html: '<div style="background:#ea4335;width:14px;height:14px;border-radius:50%;border:3px solid white;box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                })
            }).addTo(map);
            endPoint = latlng;
            document.getElementById('endInput').value = name;
            updateRouteInfo();
        }

        function updateRouteInfo() {
            const info = document.getElementById('routeInfo');
            if (startPoint && endPoint) {
                info.textContent = 'Siap cari rute';
            } else if (startPoint) {
                info.textContent = 'Pilih tujuan...';
            } else if (endPoint) {
                info.textContent = 'Pilih titik awal...';
            }
        }

        // ========== PICK MODE (MAP CLICK) ==========
        function setPickMode(mode) {
            pickingMode = mode;
            document.getElementById('map').style.cursor = 'crosshair';
            const type = mode === 'start' ? 'Awal' : 'Tujuan';
            document.getElementById('routeInfo').textContent = `Klik di peta untuk Titik ${type}...`;
        }

        map.on('click', function (e) {
            // Close search dropdown on map click
            document.getElementById('searchResults').style.display = 'none';

            if (!pickingMode) return;
            const name = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
            if (pickingMode === 'start') {
                setStartPoint(e.latlng, name);
            } else if (pickingMode === 'end') {
                setEndPoint(e.latlng, name);
            }
            document.getElementById('map').style.cursor = '';
            pickingMode = null;
        });

        // ========== LANDMARK MODAL ==========
        function openLandmarkModal(type) {
            landmarkPickingType = type;
            document.getElementById('landmarkModal').classList.add('active');
            document.getElementById('landmarkSearch').value = '';
            renderLandmarks();
        }

        function closeLandmarkModal() {
            document.getElementById('landmarkModal').classList.remove('active');
        }

        function renderLandmarks() {
            const list = document.getElementById('landmarkList');
            const search = (document.getElementById('landmarkSearch').value || '').toLowerCase();
            list.innerHTML = '';

            const filtered = masjidilHaramLocations.filter(loc =>
                (loc.properties.name || '').toLowerCase().includes(search) ||
                (loc.properties.name_en || '').toLowerCase().includes(search)
            ).slice(0, 50);

            filtered.forEach(loc => {
                const item = document.createElement('div');
                item.className = 'landmark-item';
                item.innerHTML = `
                    <i class="fa ${loc.properties.icon || 'fa-map-marker-alt'}"></i>
                    <div class="landmark-item-info">
                        <div class="name">${loc.properties.name_en || loc.properties.name}</div>
                        <div class="arabic">${loc.properties.name}</div>
                    </div>
                `;
                item.onclick = () => selectLandmark(loc);
                list.appendChild(item);
            });
        }

        function filterLandmarks() { renderLandmarks(); }

        function selectLandmark(loc) {
            const coords = loc.geometry.coordinates;
            const latlng = L.latLng(coords[1], coords[0]);
            const name = loc.properties.name_en || loc.properties.name;

            if (landmarkPickingType === 'start') {
                setStartPoint(latlng, name);
            } else {
                setEndPoint(latlng, name);
            }
            closeLandmarkModal();
            map.setView(latlng, 18);
        }

        // ========== NAVIGATION LOGIC ==========
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin((lon2 - lon1) * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos((lon2 - lon1) * Math.PI / 180);
            let brng = Math.atan2(y, x) * 180 / Math.PI;
            return (brng + 360) % 360;
        }

        function generateInstructions(path) {
            if (path.length < 2) return [];
            let steps = [];
            for (let i = 0; i < path.length - 1; i++) {
                const current = path[i];
                const next = path[i + 1];
                const dist = map.distance(current, next);
                let instruction = "Lurus terus";
                let icon = "fa-arrow-up";

                if (i > 0) {
                    const prev = path[i - 1];
                    const b1 = calculateBearing(prev[0], prev[1], current[0], current[1]);
                    const b2 = calculateBearing(current[0], current[1], next[0], next[1]);
                    let diff = b2 - b1;
                    if (diff > 180) diff -= 360;
                    if (diff < -180) diff += 360;
                    if (diff > 30) { instruction = "Belok Kanan"; icon = "fa-arrow-turn-right"; }
                    else if (diff < -30) { instruction = "Belok Kiri"; icon = "fa-arrow-turn-left"; }
                }
                steps.push({ coords: current, instruction, icon, distance: dist });
            }
            steps.push({ coords: path[path.length - 1], instruction: "Tiba di Tujuan", icon: "fa-flag-checkered", distance: 0 });
            return steps;
        }

        function startNavigation() {
            if (!currentPath || currentPath.length === 0) return;
            navigationActive = true;
            navigationSteps = generateInstructions(currentPath);
            // Show nav overlay, hide header & bottom sheet & toggle btn
            document.getElementById('navOverlay').classList.add('active');
            document.getElementById('mapHeader').style.display = 'none';
            document.getElementById('bottomSheet').style.display = 'none';
            document.getElementById('floatingBtns').style.display = 'none';
            map.locate({ watch: true, enableHighAccuracy: true });
            updateNavigationUI(0);
        }

        function stopNavigation() {
            navigationActive = false;
            map.stopLocate();
            document.getElementById('navOverlay').classList.remove('active');
            document.getElementById('mapHeader').style.display = '';
            document.getElementById('bottomSheet').style.display = '';
            document.getElementById('floatingBtns').style.display = '';
        }

        function updateNavigationUI(stepIdx) {
            if (stepIdx >= navigationSteps.length) return;
            const step = navigationSteps[stepIdx];
            document.getElementById('navMainText').innerText = step.instruction;
            document.getElementById('navIcon').innerHTML = `<i class="fa ${step.icon}"></i>`;
            document.getElementById('navDistance').innerText = `${Math.round(step.distance)} m`;
        }

        // ========== OFFLINE ROUTING (DIJKSTRA) ==========
        class PriorityQueue {
            constructor() { this.items = []; }
            enqueue(element, priority) {
                const qe = { element, priority };
                let added = false;
                for (let i = 0; i < this.items.length; i++) {
                    if (this.items[i].priority > qe.priority) {
                        this.items.splice(i, 0, qe);
                        added = true;
                        break;
                    }
                }
                if (!added) this.items.push(qe);
            }
            dequeue() { return this.items.shift(); }
            isEmpty() { return this.items.length === 0; }
        }

        function findNearestNode(lat, lon) {
            let minDist = Infinity;
            let closestNode = null;
            if (typeof routingGraph === 'undefined') return null;
            for (const id in routingGraph.nodes) {
                const coords = routingGraph.nodes[id];
                const d = (lat - coords[0]) ** 2 + (lon - coords[1]) ** 2;
                if (d < minDist) { minDist = d; closestNode = id; }
            }
            return closestNode;
        }

        function dijkstra(startNode, endNode) {
            const distances = {};
            const previous = {};
            const queue = new PriorityQueue();
            distances[startNode] = 0;
            queue.enqueue(startNode, 0);
            const nodes = routingGraph.nodes;
            const adj = routingGraph.adj;

            while (!queue.isEmpty()) {
                const { element: current } = queue.dequeue();
                if (current === endNode) {
                    const path = [];
                    let u = endNode;
                    while (u) { path.unshift(nodes[u]); u = previous[u]; }
                    return path;
                }
                if (!adj[current]) continue;
                for (const neighbor in adj[current]) {
                    const weight = adj[current][neighbor];
                    const alt = distances[current] + weight;
                    if (alt < (distances[neighbor] ?? Infinity)) {
                        distances[neighbor] = alt;
                        previous[neighbor] = current;
                        queue.enqueue(neighbor, alt);
                    }
                }
            }
            return null;
        }

        function calculateRoute() {
            if (!startPoint || !endPoint) {
                alert("Harap pilih titik awal dan tujuan.");
                return;
            }
            if (typeof routingGraph === 'undefined') {
                alert("Data routing graph belum siap.");
                return;
            }

            const btn = document.getElementById('routeBtn');
            btn.innerText = "Menghitung...";
            btn.disabled = true;

            setTimeout(() => {
                const startNode = findNearestNode(startPoint.lat, startPoint.lng);
                const endNode = findNearestNode(endPoint.lat, endPoint.lng);

                if (startNode) {
                    const sc = routingGraph.nodes[startNode];
                    const d = Math.sqrt((startPoint.lat - sc[0]) ** 2 + (startPoint.lng - sc[1]) ** 2) * 111000;
                    if (d > 200) {
                        if (!confirm("Titik awal agak jauh (>200m) dari jalur terdata. Lanjutkan?")) {
                            btn.innerText = "Cari Rute"; btn.disabled = false;
                            return;
                        }
                    }
                }

                if (!startNode || !endNode) {
                    alert("Gagal menemukan titik jalur terdekat.");
                    btn.innerText = "Cari Rute"; btn.disabled = false;
                    return;
                }

                const path = dijkstra(startNode, endNode);
                if (path) {
                    currentPath = path;
                    if (routeLayer) map.removeLayer(routeLayer);
                    routeLayer = L.polyline(path, {
                        color: '#1a73e8',
                        weight: 6,
                        opacity: 0.8,
                        dashArray: '10, 10',
                        lineCap: 'round'
                    }).addTo(map);
                    map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });

                    let totalDist = 0;
                    for (let i = 0; i < path.length - 1; i++) {
                        totalDist += map.distance(path[i], path[i + 1]);
                    }
                    const timeMins = Math.round(totalDist / 80);

                    document.getElementById('routeInfo').innerHTML =
                        `<strong>${Math.round(totalDist)} m</strong> &middot; ~${timeMins} menit jalan kaki`;
                    document.getElementById('startNavBtn').style.display = '';

                    btn.innerText = "Cari Rute"; btn.disabled = false;
                } else {
                    alert("Tidak ada jalur yang terhubung.");
                    btn.innerText = "Cari Rute"; btn.disabled = false;
                }
            }, 50);
        }

        // ========== EXTRA LAYERS ==========
        function renderExtraLayers() {
            if (typeof masjidilHaramRoads !== 'undefined' && masjidilHaramRoads.length > 0) {
                masjidilHaramRoads.forEach(road => {
                    const polyline = L.polyline(road.geometry.coordinates, {
                        color: '#a8a29e', weight: 2, opacity: 0.6
                    });
                    const name = road.properties.name || road.properties.highway_type || 'Road';
                    const nameAr = road.properties.name_ar || name;
                    polyline.bindPopup(`<b>${nameAr}</b><br>${name}`);
                    roadsLayer.addLayer(polyline);
                });
                roadsLayer.addTo(map);
            }

            if (typeof masjidilHaramBuildings !== 'undefined' && masjidilHaramBuildings.length > 0) {
                masjidilHaramBuildings.forEach(building => {
                    const polygon = L.polygon(building.geometry.coordinates, {
                        color: '#c2410c', weight: 1, fillColor: '#fdba74', fillOpacity: 0.2
                    });
                    const name = building.properties.name || building.properties.building_type || 'Building';
                    const nameAr = building.properties.name_ar || name;
                    polygon.bindPopup(`<b>${nameAr}</b><br>${name}`);
                    buildingsLayer.addLayer(polygon);
                });
            }
        }

        // ========== SHARE ==========
        function shareLocation(name, lat, lng) {
            const mapsUrl = lat && lng ? `https://www.google.com/maps?q=${lat},${lng}` : '';
            const shareText = mapsUrl ? `${name}\n${mapsUrl}` : name;

            if (navigator.share) {
                const shareData = { title: name, text: `Lokasi: ${name}` };
                if (mapsUrl) shareData.url = mapsUrl;
                navigator.share(shareData);
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Link lokasi telah disalin!');
                }).catch(() => {
                    prompt('Salin link lokasi:', shareText);
                });
            } else {
                prompt('Salin link lokasi:', shareText);
            }
        }

        // ========== LOAD DATA ==========
        masjidilHaramLocations.forEach(location => {
            const marker = createPinholeMarker(location);
            const type = location.properties.type;
            const clusterTypes = ['Support', 'Hotel', 'Landmark', 'Transportation', 'Food', 'Holy Site', 'Mosque', 'W C'];
            if (clusterTypes.includes(type)) {
                clusterGroup.addLayer(marker);
            } else {
                markersLayer.addLayer(marker);
            }
        });

        renderLocationsList();
        renderExtraLayers();
    </script>

    <footer
        style="text-align: center; padding: 1.5rem; color: #5f6368; font-size: 0.85rem; background: #fafafa; border-top: 1px solid #e0e0e0; position: relative; z-index: 10;">
        <p>¬© Copyright Sahabat Al-Fatihah</p>
    </footer>
</body>

</html>