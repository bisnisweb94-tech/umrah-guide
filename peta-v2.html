<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Peta Premium Masjidil Haram - AL HARAMAIN</title>

    <!-- Leaflet & GIS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- Fonts & Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Amiri:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            background: #f5f5f5;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        /* ========== GOOGLE MAPS STYLE HEADER ========== */
        .map-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .search-box {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 12px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: #f1f3f4;
            border-radius: 8px;
            padding: 10px 14px;
            gap: 10px;
        }

        .search-input-wrapper input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font-size: 16px;
            color: #202124;
        }

        .search-input-wrapper i {
            color: #5f6368;
        }

        /* Category chips like Google Maps */
        .category-chips {
            display: flex;
            gap: 8px;
            padding: 0 16px 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .category-chips::-webkit-scrollbar {
            display: none;
        }

        .chip {
            padding: 8px 14px;
            border-radius: 20px;
            background: white;
            border: 1px solid #dadce0;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chip:hover,
        .chip.active {
            background: #e8f0fe;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        .chip i {
            margin-right: 6px;
        }

        /* ========== PINHOLE MARKERS (APPLE MAPS STYLE) ========== */
        .pinhole-marker {
            background: none !important;
            border: none !important;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Default: small plain dot */
        .pinhole-marker .marker-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pinhole-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #1a73e8;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hide icon by default */
        .pinhole-dot i {
            display: none;
            color: white;
            font-size: 20px;
            transition: all 0.3s;
        }

        /* Hide label by default */
        .marker-label {
            display: none;
            margin-top: 4px;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: #202124;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        /* Active state: transform to pin with icon */
        .pinhole-marker.active .pinhole-dot {
            width: 48px;
            height: 48px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            border: 4px solid white;
            animation: pinPop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pinhole-marker.active .pinhole-dot i {
            display: block;
            transform: rotate(45deg);
        }

        .pinhole-marker.active .marker-label {
            display: block;
            animation: labelFade 0.3s ease-in 0.2s both;
        }

        @keyframes pinPop {
            0% {
                transform: rotate(-45deg) scale(0.5);
            }

            60% {
                transform: rotate(-45deg) scale(1.1);
            }

            100% {
                transform: rotate(-45deg) scale(1);
            }
        }

        @keyframes labelFade {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Hover effect */
        .pinhole-marker:hover .pinhole-dot {
            transform: scale(1.3);
        }

        .pinhole-marker.active:hover .pinhole-dot {
            transform: rotate(-45deg) scale(1.05);
        }

        /* Category colors */
        .pinhole-dot.holy-site {
            background: #d4af37;
        }

        .pinhole-dot.gate {
            background: #3498db;
        }

        .pinhole-dot.hotel {
            background: #8e44ad;
        }

        .pinhole-dot.medical {
            background: #e67e22;
        }

        .pinhole-dot.wc {
            background: #06b6d4;
        }

        .pinhole-dot.food {
            background: #10b981;
        }

        .pinhole-dot.landmark {
            background: #e74c3c;
        }

        .pinhole-dot.transportation {
            background: #6366f1;
        }

        /* ========== BOTTOM SHEET (APPLE MAPS STYLE) ========== */
        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            transform: translateY(calc(100% - 80px));
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 70vh;
            display: flex;
            flex-direction: column;
        }

        .bottom-sheet.expanded {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 36px;
            height: 4px;
            background: #dadce0;
            border-radius: 2px;
            margin: 8px auto;
            cursor: grab;
        }

        .sheet-peek {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f3f4;
        }

        .peek-title {
            font-size: 18px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 4px;
        }

        .peek-subtitle {
            font-size: 14px;
            color: #5f6368;
        }

        .sheet-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .location-detail {
            display: none;
        }

        .location-detail.active {
            display: block;
        }

        .detail-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
        }

        .detail-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .detail-info h2 {
            font-size: 24px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 4px;
        }

        .detail-info .arabic {
            font-family: 'Amiri', serif;
            font-size: 20px;
            color: #d4af37;
            display: block;
            margin-top: 4px;
        }

        .detail-info p {
            font-size: 14px;
            color: #5f6368;
            margin-top: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin: 20px 0;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background: #1a73e8;
            color: white;
        }

        .action-btn.primary:hover {
            background: #1557b0;
        }

        .action-btn.secondary {
            background: #f1f3f4;
            color: #202124;
        }

        .action-btn.secondary:hover {
            background: #e8eaed;
        }

        /* Locations List */
        .locations-list {
            padding: 0;
        }

        .list-category {
            margin-bottom: 24px;
        }

        .category-header {
            font-size: 12px;
            font-weight: 500;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .location-item:hover {
            background: #e8f0fe;
        }

        .item-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }

        .item-info h3 {
            font-size: 15px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 2px;
        }

        .item-info .arabic {
            font-family: 'Amiri', serif;
            font-size: 13px;
            color: #5f6368;
        }

        /* Cluster Styles */
        .marker-cluster-small,
        .marker-cluster-medium,
        .marker-cluster-large {
            background-color: rgba(26, 115, 232, 0.3) !important;
        }

        .marker-cluster div {
            background-color: #1a73e8 !important;
            color: white !important;
            border: 3px solid white;
            font-weight: 700;
            border-radius: 50%;
        }

        /* Hide default leaflet popup */
        .leaflet-popup {
            display: none !important;
        }

        /* ========== DIRECTIONS BOX (GOOGLE MAPS STYLE) ========== */
        .directions-box {
            display: none;
            padding: 16px;
            background: white;
            flex-direction: column;
            gap: 12px;
            border-bottom: 1px solid #f1f3f4;
        }

        .directions-box.active {
            display: flex;
        }

        .dir-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dir-dots {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .dot-start {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 2px solid #1a73e8;
        }

        .dot-line {
            width: 2px;
            height: 20px;
            background: #dadce0;
        }

        .dot-end {
            width: 8px;
            height: 8px;
            background: #1a73e8;
        }

        .dir-inputs {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dir-input-wrapper {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dir-input-wrapper input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font-size: 14px;
            color: #202124;
        }

        .dir-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }

        .nav-btn-start {
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 24px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* ========== NAVIGATION OVERLAY (APPLE MAPS STYLE) ========== */
        .nav-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: #202124;
            color: white;
            border-radius: 16px;
            padding: 16px;
            display: none;
            align-items: center;
            gap: 16px;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .nav-overlay.active {
            display: flex;
        }

        .nav-icon-large {
            font-size: 32px;
            color: #1a73e8;
        }

        .nav-text {
            flex: 1;
        }

        .nav-instruction {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .nav-sub-instruction {
            font-size: 14px;
            color: #bdc1c6;
        }

        .nav-close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .bottom-sheet {
                left: 400px;
                max-width: 450px;
                border-radius: 16px;
                transform: translateY(0);
                max-height: calc(100vh - 120px);
                top: 100px;
                bottom: 20px;
            }

            .map-header {
                left: 20px;
                top: 20px;
                width: 360px;
                border-radius: 16px;
                overflow: hidden;
            }

            .nav-overlay {
                left: 400px;
                right: 20px;
                top: 20px;
                max-width: 450px;
            }
        }
    </style>
</head>

<body>

    <!-- Google Maps Style Header -->
    <div class="map-header">
        <div class="search-box" id="searchBox">
            <button class="back-btn" onclick="window.location.href='index.html'">
                <i class="fa fa-arrow-left"></i>
            </button>
            <div class="search-input-wrapper">
                <i class="fa fa-search"></i>
                <input type="text" id="searchInput" placeholder="Cari lokasi, gerbang, fasilitas..."
                    onkeyup="filterLocations()">
            </div>
            <button class="back-btn" style="box-shadow: none; display: none;" id="closeDirectionsBtn"
                onclick="exitDirections()">
                <i class="fa fa-times"></i>
            </button>
        </div>

        <!-- Directions Search Box -->
        <div class="directions-box" id="directionsBox">
            <div class="dir-input-group">
                <div class="dir-dots">
                    <div class="dot-start"></div>
                    <div class="dot-line"></div>
                    <div class="dot-end"></div>
                </div>
                <div class="dir-inputs">
                    <div class="dir-input-wrapper">
                        <input type="text" id="startInput" placeholder="Pilih titik awal..." readonly
                            onclick="setPickMode('start')">
                    </div>
                    <div class="dir-input-wrapper">
                        <input type="text" id="endInput" placeholder="Pilih tujuan..." readonly
                            onclick="setPickMode('end')">
                    </div>
                </div>
            </div>
            <div class="dir-actions">
                <span id="routeInfo" style="font-size: 13px; color: #5f6368;">Pilih lokasi di peta</span>
                <button class="nav-btn-start" id="startNavBtn" style="display: none;"
                    onclick="startNavigation()">Mulai</button>
            </div>
        </div>

        <div class="category-chips" id="categoryChips">
            <div class="chip active" data-category="all"><i class="fa fa-globe"></i> Semua</div>
            <div class="chip" data-category="Holy Site"><i class="fa fa-kaaba"></i> Holy Site</div>
            <div class="chip" data-category="Gate"><i class="fa fa-door-open"></i> Gerbang</div>
            <div class="chip" data-category="Hotel"><i class="fa fa-hotel"></i> Hotel</div>
            <div class="chip" data-category="W C"><i class="fa fa-restroom"></i> WC</div>
            <div class="chip" data-category="Medical"><i class="fa fa-hospital"></i> Medis</div>
            <div class="chip" data-category="Food"><i class="fa fa-utensils"></i> Makanan</div>
        </div>
    </div>

    <!-- Apple Maps Style Navigation Overlay -->
    <div class="nav-overlay" id="navOverlay">
        <div class="nav-icon-large" id="navIcon">
            <i class="fa fa-arrow-up"></i>
        </div>
        <div class="nav-text">
            <div class="nav-instruction" id="navMainText">Lurus terus</div>
            <div class="nav-sub-instruction" id="navSubText">Tetap di jalur</div>
        </div>
        <div style="text-align: right; margin-right: 10px;">
            <div id="navDistance" style="font-size: 20px; font-weight: bold; color: #1a73e8;">0 m</div>
        </div>
        <button class="nav-close-btn" onclick="stopNavigation()">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- Bottom Sheet -->
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-handle" id="sheetHandle"></div>
        <div class="sheet-peek">
            <div class="peek-title">Masjidil Haram</div>
            <div class="peek-subtitle">Tap untuk menjelajahi lokasi</div>
        </div>
        <div class="sheet-content" id="sheetContent">
            <!-- Location detail will appear here when marker is clicked -->
            <div id="locationDetail" class="location-detail"></div>

            <!-- Locations list by default -->
            <div id="locationsList" class="locations-list"></div>
        </div>
    </div>

    <div id="map"></div>

    <!-- Data & Scripts -->
    <script src="masjidil-haram-data.js"></script>
    <script src="osm_data/haram-routing-graph-v2.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // Initialize map
        const map = L.map('map', {
            zoomControl: false,
            center: [21.4225, 39.8262],
            zoom: 17,
            maxZoom: 19,
            minZoom: 13
        });

        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Esri Satellite Layer
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 19
        }).addTo(map);

        // Color mapping
        const markerColors = {
            'Holy Site': '#d4af37',
            'Main Gate': '#064e3b',
            'Gate': '#3498db',
            'Hotel': '#8e44ad',
            'Medical': '#e67e22',
            'W C': '#06b6d4',
            'Food': '#10b981',
            'Zamzam/Water': '#3b82f6',
            'Elevator': '#8b5cf6',
            'Escalator': '#ec4899',
            'Stairs': '#f97316',
            'Transportation': '#6366f1',
            'Amenities': '#f59e0b',
            'Support': '#475569',
            'Landmark': '#e74c3c'
        };

        const markersLayer = L.layerGroup().addTo(map);
        const clusterGroup = L.markerClusterGroup({
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            spiderfyOnMaxZoom: true,
            maxClusterRadius: 50
        }).addTo(map);

        let activeMarker = null;
        let allMarkers = [];

        // Create pinhole marker
        function createPinholeMarker(feature) {
            const type = feature.properties.type;
            const color = markerColors[type] || '#1a73e8';
            const categoryClass = type.toLowerCase().replace(/ /g, '-');
            const iconClass = feature.properties.icon || 'fa-map-marker';
            const name = feature.properties.name_en || feature.properties.name;

            const icon = L.divIcon({
                className: 'pinhole-marker',
                html: `
                    <div class="marker-container">
                        <div class="pinhole-dot ${categoryClass}" style="background: ${color};">
                            <i class="fa ${iconClass}"></i>
                        </div>
                        <div class="marker-label">${name}</div>
                    </div>
                `,
                iconSize: [80, 80],
                iconAnchor: [40, 70]
            });

            const coords = feature.geometry.coordinates;
            const marker = L.marker([coords[1], coords[0]], { icon: icon });

            marker.on('click', function () {
                showLocationDetail(feature, marker);

                // Remove active from all markers
                if (activeMarker && activeMarker !== marker) {
                    activeMarker.getElement().classList.remove('active');
                }

                // Add active to clicked marker
                marker.getElement().classList.add('active');
                activeMarker = marker;

                // Center map on marker
                map.flyTo([coords[1], coords[0]], 18);
            });

            allMarkers.push({ marker, feature });
            return marker;
        }

        // Show location detail in bottom sheet
        function showLocationDetail(feature, marker) {
            const props = feature.properties;
            const type = props.type;
            const color = markerColors[type] || '#1a73e8';

            const detailHTML = `
                <div class="detail-header">
                    <div class="detail-icon" style="background: ${color};">
                        <i class="fa ${props.icon || 'fa-map-marker'}"></i>
                    </div>
                    <div class="detail-info">
                        <h2>${props.name_en || props.name}</h2>
                        <span class="arabic">${props.name}</span>
                        <p>${props.description || type}</p>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="routeToLocation(${feature.geometry.coordinates})">
                        <i class="fa fa-directions"></i> Arah
                    </button>
                    <button class="action-btn secondary" onclick="shareLocation('${props.name}')">
                        <i class="fa fa-share"></i> Bagikan
                    </button>
                </div>
            `;

            document.getElementById('locationDetail').innerHTML = detailHTML;
            document.getElementById('locationDetail').classList.add('active');
            document.getElementById('locationsList').style.display = 'none';

            // Expand bottom sheet
            document.getElementById('bottomSheet').classList.add('expanded');
        }

        // Render locations list
        function renderLocationsList(data = masjidilHaramLocations) {
            const grouped = {};
            data.forEach(item => {
                const t = item.properties.type;
                if (!grouped[t]) grouped[t] = [];
                grouped[t].push(item);
            });

            const typeOrder = [
                'Holy Site', 'Main Gate', 'Gate',
                'W C', 'Zamzam/Water', 'Medical', 'Transportation',
                'Hotel', 'Food', 'Amenities',
                'Escalator', 'Elevator', 'Stairs',
                'Support', 'Landmark'
            ];

            let html = '';
            typeOrder.forEach(type => {
                if (!grouped[type]) return;

                const color = markerColors[type] || '#475569';
                html += `
                    <div class="list-category">
                        <div class="category-header">
                            <i class="fa fa-folder"></i> ${type} (${grouped[type].length})
                        </div>
                `;

                grouped[type].slice(0, 10).forEach(item => {
                    html += `
                        <div class="location-item" onclick="selectLocation('${item.properties.osm_id}')">
                            <div class="item-icon" style="background: ${color};">
                                <i class="fa ${item.properties.icon}"></i>
                            </div>
                            <div class="item-info">
                                <h3>${item.properties.name_en || item.properties.name}</h3>
                                <div class="arabic">${item.properties.name}</div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            });

            document.getElementById('locationsList').innerHTML = html;
        }

        // Select location from list
        function selectLocation(osmId) {
            const item = allMarkers.find(m => m.feature.properties.osm_id === osmId);
            if (item) {
                item.marker.fire('click');
            }
        }

        // Filter locations
        function filterLocations() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = masjidilHaramLocations.filter(loc =>
                (loc.properties.name || '').toLowerCase().includes(query) ||
                (loc.properties.name_en || '').toLowerCase().includes(query) ||
                (loc.properties.type || '').toLowerCase().includes(query)
            );
            renderLocationsList(filtered);
        }

        // Category filter
        document.querySelectorAll('.chip').forEach(chip => {
            chip.addEventListener('click', function () {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                this.classList.add('active');

                const category = this.dataset.category;
                if (category === 'all') {
                    renderLocationsList();
                } else {
                    const filtered = masjidilHaramLocations.filter(loc => loc.properties.type === category);
                    renderLocationsList(filtered);
                }
            });
        });

        // Bottom sheet drag
        let startY = 0;
        let sheetStartY = 0;
        const sheet = document.getElementById('bottomSheet');
        const handle = document.getElementById('sheetHandle');

        handle.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            sheetStartY = sheet.getBoundingClientRect().top;
        });

        handle.addEventListener('touchmove', (e) => {
            const currentY = e.touches[0].clientY;
            const diff = currentY - startY;
            sheet.style.transform = `translateY(${Math.max(0, diff)}px)`;
        });

        handle.addEventListener('touchend', (e) => {
            const currentY = sheet.getBoundingClientRect().top;
            if (currentY > window.innerHeight * 0.5) {
                sheet.classList.remove('expanded');
                sheet.style.transform = '';
            } else {
                sheet.classList.add('expanded');
                sheet.style.transform = '';
            }
        });

        // Initialize Global Variables for Routing
        let startPoint = null;
        let endPoint = null;
        let startMarker = null;
        let endMarker = null;
        let routeLayer = null;
        let currentPath = [];
        let navigationActive = false;
        let pickingMode = null;

        // Offline Routing Logic (Dijkstra)
        class PriorityQueue {
            constructor() { this.items = []; }
            enqueue(element, priority) {
                const qElement = { element, priority };
                let added = false;
                for (let i = 0; i < this.items.length; i++) {
                    if (this.items[i].priority > qElement.priority) {
                        this.items.splice(i, 0, qElement);
                        added = true;
                        break;
                    }
                }
                if (!added) this.items.push(qElement);
            }
            dequeue() { return this.items.shift(); }
            isEmpty() { return this.items.length === 0; }
        }

        function findNearestNode(lat, lon) {
            let minDist = Infinity;
            let closestNode = null;
            if (typeof routingGraph === 'undefined') return null;

            for (const id in routingGraph.nodes) {
                const coords = routingGraph.nodes[id];
                const d = (lat - coords[0]) ** 2 + (lon - coords[1]) ** 2;
                if (d < minDist) {
                    minDist = d;
                    closestNode = id;
                }
            }
            return closestNode;
        }

        function dijkstra(startNode, endNode) {
            const distances = {};
            const previous = {};
            const queue = new PriorityQueue();

            distances[startNode] = 0;
            queue.enqueue(startNode, 0);

            const nodes = routingGraph.nodes;
            const adj = routingGraph.adj;

            while (!queue.isEmpty()) {
                const { element: current, priority } = queue.dequeue();
                if (current === endNode) {
                    const path = [];
                    let u = endNode;
                    while (u) {
                        path.unshift(nodes[u]);
                        u = previous[u];
                    }
                    return path;
                }
                if (!adj[current]) continue;
                for (const neighbor in adj[current]) {
                    const weight = adj[current][neighbor];
                    const alt = distances[current] + weight;
                    if (alt < (distances[neighbor] ?? Infinity)) {
                        distances[neighbor] = alt;
                        previous[neighbor] = current;
                        queue.enqueue(neighbor, alt);
                    }
                }
            }
            return null;
        }

        // --- Interaction Logic ---

        function routeToLocation(lon, lat) {
            // lon, lat from feature.geometry.coordinates
            endPoint = L.latLng(lat, lon);
            const feature = masjidilHaramLocations.find(l => l.geometry.coordinates[0] === lon && l.geometry.coordinates[1] === lat);
            const name = feature ? (feature.properties.name_en || feature.properties.name) : `${lat.toFixed(5)}, ${lon.toFixed(5)}`;

            setEndPoint(endPoint, name);

            // UI Transition
            document.getElementById('searchBox').style.display = 'none';
            document.getElementById('categoryChips').style.display = 'none';
            document.getElementById('directionsBox').classList.add('active');
            document.getElementById('closeDirectionsBtn').style.display = 'flex';
            document.getElementById('bottomSheet').classList.remove('expanded');

            // Try to use current location as start if available
            map.locate({ setView: false });
        }

        function exitDirections() {
            document.getElementById('searchBox').style.display = 'flex';
            document.getElementById('categoryChips').style.display = 'flex';
            document.getElementById('directionsBox').classList.remove('active');
            document.getElementById('closeDirectionsBtn').style.display = 'none';
            if (routeLayer) map.removeLayer(routeLayer);
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            startPoint = null;
            endPoint = null;
            document.getElementById('startNavBtn').style.display = 'none';
            document.getElementById('routeInfo').innerText = "Pilih lokasi di peta";
        }

        function setPickMode(mode) {
            pickingMode = mode;
            document.getElementById('map').style.cursor = 'crosshair';
            const type = mode === 'start' ? 'Awal' : 'Tujuan';
            document.getElementById('routeInfo').innerText = `Klik di peta untuk titik ${type}...`;
        }

        map.on('click', function (e) {
            if (!pickingMode) return;
            const name = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
            if (pickingMode === 'start') {
                setStartPoint(e.latlng, name);
            } else if (pickingMode === 'end') {
                setEndPoint(e.latlng, name);
            }
            document.getElementById('map').style.cursor = '';
            pickingMode = null;
            calculateRoute();
        });

        function setStartPoint(latlng, name) {
            if (startMarker) map.removeLayer(startMarker);
            startMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'start-marker',
                    html: '<div style="background:#1a73e8;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow: 0 0 10px rgba(26,115,232,0.5);"></div>'
                })
            }).addTo(map);
            startPoint = latlng;
            document.getElementById('startInput').value = name;
        }

        function setEndPoint(latlng, name) {
            if (endMarker) map.removeLayer(endMarker);
            endMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'end-marker',
                    html: '<div style="background:#d4af37;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow: 0 0 10px rgba(212,175,55,0.5);"></div>'
                })
            }).addTo(map);
            endPoint = latlng;
            document.getElementById('endInput').value = name;
        }

        function calculateRoute() {
            if (!startPoint || !endPoint) return;

            const startNode = findNearestNode(startPoint.lat, startPoint.lng);
            const endNode = findNearestNode(endPoint.lat, endPoint.lng);

            const path = dijkstra(startNode, endNode);
            if (path) {
                currentPath = path;
                if (routeLayer) map.removeLayer(routeLayer);
                routeLayer = L.polyline(path, {
                    color: '#1a73e8',
                    weight: 6,
                    opacity: 0.8,
                    lineCap: 'round'
                }).addTo(map);

                map.fitBounds(routeLayer.getBounds(), { padding: [100, 100] });

                let totalDist = 0;
                for (let i = 0; i < path.length - 1; i++) {
                    totalDist += map.distance(path[i], path[i + 1]);
                }
                const timeMins = Math.round(totalDist / 80);
                document.getElementById('routeInfo').innerText = `${Math.round(totalDist)}m â€¢ ~${timeMins} mnt`;
                document.getElementById('startNavBtn').style.display = 'block';
            } else {
                alert("Jalur tidak ditemukan.");
            }
        }

        // --- Navigation Logic ---

        function startNavigation() {
            if (currentPath.length === 0) return;
            navigationActive = true;
            document.getElementById('navOverlay').classList.add('active');
            document.getElementById('directionsBox').classList.remove('active');
            document.getElementById('map').classList.add('navigating');

            // Auto start tracking
            map.locate({ watch: true, setView: true, maxZoom: 18 });
        }

        function stopNavigation() {
            navigationActive = false;
            document.getElementById('navOverlay').classList.remove('active');
            document.getElementById('directionsBox').classList.add('active');
            map.stopLocate();
        }

        map.on('locationfound', function (e) {
            if (navigationActive) {
                let minDiv = Infinity;
                let nearestIdx = 0;

                currentPath.forEach((p, idx) => {
                    const d = map.distance(e.latlng, p);
                    if (d < minDiv) {
                        minDiv = d;
                        nearestIdx = idx;
                    }
                });

                updateNavigationUI(nearestIdx);
            } else if (pickingMode === 'start') {
                setStartPoint(e.latlng, "Lokasi Saya");
                pickingMode = null;
                calculateRoute();
            }
        });

        function updateNavigationUI(idx) {
            const nextIdx = Math.min(idx + 1, currentPath.length - 1);
            const remainingPath = currentPath.slice(idx);

            let remainingDist = 0;
            for (let i = 0; i < remainingPath.length - 1; i++) {
                remainingDist += map.distance(remainingPath[i], remainingPath[i + 1]);
            }

            document.getElementById('navDistance').innerText = `${Math.round(remainingDist)} m`;

            // Simple instruction logic
            if (idx === currentPath.length - 1) {
                document.getElementById('navMainText').innerText = "Tiba di tujuan";
                document.getElementById('navSubText').innerText = "Anda telah sampai";
                document.getElementById('navIcon').innerHTML = '<i class="fa fa-flag-checkered"></i>';
            } else {
                generateInstructions(idx);
            }
        }

        function generateInstructions(idx) {
            // Turn detection logic simplified
            document.getElementById('navMainText').innerText = "Lurus terus";
            document.getElementById('navSubText').innerText = "Ikuti jalur biru";
            document.getElementById('navIcon').innerHTML = '<i class="fa fa-arrow-up"></i>';
        }

        function shareLocation(name) {
            if (navigator.share) {
                navigator.share({ title: name, text: `Lokasi: ${name}` });
            } else {
                alert(`Bagikan: ${name}`);
            }
        }

        // --- Initialization ---
        masjidilHaramLocations.forEach(location => {
            const marker = createPinholeMarker(location);
            const type = location.properties.type;
            const clusterTypes = ['Hotel', 'Landmark', 'Transportation', 'Food', 'Holy Site'];

            if (clusterTypes.includes(type)) {
                clusterGroup.addLayer(marker);
            } else {
                markersLayer.addLayer(marker);
            }
        });

        renderLocationsList();
    </script>

</body>

</html>